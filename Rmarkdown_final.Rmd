---
title: "Modelos de Clasificación para Riesgo Crediticio"
author: "Barros Rayo Alejandro (2415837), Muñoz Portela Diego Fernando (2415620), Portilla Aguirre Johan Camilo (2422468), Aguirre Aldana Joan Sebastian (2419550)"
output: 
  html_document:
    theme: lumen
    highlight: textmate
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    number_sections: true
    code_folding: show
---
# Introducción


# Metodología

## Fuente de datos 
## Definición de variables


## Preparación y limpieza de datos 
# Análisis descriptivo
```{r sep, echo = FALSE, warning = FALSE, message = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(tidyr)
library(readr)
library(tidyverse)
library(class)
library(caret)
library(pROC)
library(ggthemes)
library(lubridate)
library(kableExtra)
library(knitr)
library(ggcorrplot)
library(scales)
```


```{r tema2, echo = FALSE, warning = FALSE, message = FALSE}
tema <- theme_minimal() +
  theme(
    text = element_text(family = "Segoe UI", color = "#2d3748"),
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, color = "#323130"),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "#605e5c", margin = margin(b = 15)),
    plot.caption = element_text(size = 10, color = "#605e5c", hjust = 0),
    panel.grid.major = element_line(color = "#f3f2f1"),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    axis.title = element_text(face = "bold", color = "#323130"),
    axis.text = element_text(color = "#605e5c"),
    legend.position = "none"
  )
```

```{r carga_datos, echo = FALSE, warning = FALSE, message = FALSE}
lending_raw <- read_csv("LC_loans_granting_model_dataset.csv", guess_max = 20000)

lending_base <- lending_raw %>%
  select(revenue, dti_n, loan_amnt, fico_n, Default, purpose, issue_d) %>%
  rename(
    ingreso = revenue,
    relacion_deuda_ingreso = dti_n,
    monto_prestamo = loan_amnt,
    puntaje_fico = fico_n,
    estado_pago = Default,
    proposito = purpose
  ) %>%
  mutate(
    fecha_emision = parse_date_time(issue_d, orders = "b-Y", locale = "en_US"),
    Año = year(fecha_emision),
    proposito = as.factor(proposito),
    proposito_agrupado = fct_collapse(
      proposito,
      Consolidacion = c("debt_consolidation", "credit_card"),
      Casa_Vehiculo = c("home_improvement", "major_purchase", "car", "house"),
      Negocio_Estudio = c("small_business", "educational")
    ),
    proposito_agrupado = fct_other(
      proposito_agrupado,
      keep = c("Consolidacion", "Casa_Vehiculo", "Negocio_Estudio"),
      other_level = "Otros"
    ),
    estado_pago = fct_recode(as.factor(estado_pago), "Paga" = "0", "No_paga" = "1")
  ) %>%
  select(-proposito)

lending_base <- lending_base %>%
  filter(ingreso <= 250000, relacion_deuda_ingreso <= 50) %>%
  drop_na()
```

```{r resumen_general, echo = FALSE, warning = FALSE, message = FALSE}

resumen_general <- lending_base %>%
  select(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico) %>%
  summarise_all(list(
    n = ~sum(!is.na(.)),
    media = ~mean(., na.rm = TRUE),
    mediana = ~median(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE),
    minimo = ~min(., na.rm = TRUE),
    maximo = ~max(., na.rm = TRUE)
  )) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("variable", ".value"),
    names_pattern = "^(.*)_(n|media|mediana|sd|minimo|maximo)$"
  )
```
titulo1
Introducción general del dataset
```{r tabla_resumen }

tabla_resumen = resumen_general %>%
  select(-n) %>%  
  kable(
    format = "html",
    col.names = c("Variable", "Media", "Mediana", "Desv. Estándar", "Mínimo", "Máximo"),
    align = c('l', 'r', 'r', 'r', 'r', 'r'),
    caption = "Tabla 1: Estadísticas Descriptivas de las Variables Principales del Dataset de Préstamos"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2, width = "2cm") %>%
  column_spec(3, width = "2cm") %>%
  column_spec(4, width = "2.5cm") %>%
  column_spec(5, width = "2cm") %>%
  column_spec(6, width = "2cm") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en datos de Lending Club",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

tabla_resumen
```
palabras sobre la tabla 


```{r tabla_frecuencias}

tabla_estado <- as.data.frame(table(lending_base$estado_pago))
colnames(tabla_estado) <- c("estado_pago", "n")
tabla_estado$porcentaje <- round(prop.table(tabla_estado$n) * 100, 2)

tabla_estado %>%
  kbl(
    caption = "Tabla 2: Distribución de Frecuencias por Estado de Pago",
    align = c("l", "r", "r"),
    col.names = c("Estado Pago", "Frecuencia", "Porcentaje (%)")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2:3, width = "2.5cm") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en datos de Lending Club",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )
```
hablar sobre tabla 2

titulo2
Distribución individual de variables numéricas



```{r p1}
library(plotly)

p1 <- ggplot(lending_base, aes(x = ingreso)) +
  geom_histogram(binwidth = 5000,
                 fill = "#2b6cb0",
                 color = "white",
                 alpha = 0.8) +
  geom_vline(xintercept = median(lending_base$ingreso, na.rm = TRUE),
             color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = scales::dollar_format(prefix = "$", big.mark = ",")) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Histograma de ingreso (mediana en rojo)",
    x = "Ingreso",
    y = "Frecuencia"
  ) +
  tema
p1

```



comentario histograma


```{r pdti}
p_dti <- ggplot(lending_base, aes(x = relacion_deuda_ingreso)) +
  geom_density(fill = "#2a9d8f",       
               color = "#1b4d47",      
               alpha = 0.4,
               size = 1.1) +
  geom_vline(aes(xintercept = median(relacion_deuda_ingreso, na.rm = TRUE)),
             color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    title = "Distribución de la relación deuda/ingreso",
    x = "Relación deuda/ingreso (%)",
    y = "Densidad"
  ) +
  tema

p_dti


```


comentario distribucion

```{r fico}
p_fico <- ggplot(lending_base, aes(x = puntaje_fico)) +
  geom_density(
    bw = 15,                # suaviza la curva (ajusta entre 10–25 según tus datos)
    fill = "#52b788",       # verde más elegante
    color = "#1b4332",      # borde oscuro
    alpha = 0.8,
    size = 1.1
  ) +
  geom_vline(
    xintercept = median(lending_base$puntaje_fico, na.rm = TRUE),
    color = "#e63946", linetype = "dashed", size = 1
  ) +
  scale_x_continuous(
    breaks = seq(600, 850, 25),
    limits = c(600, 850)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::comma_format()
  ) +
  labs(
    title = "Distribución del puntaje FICO",
    x = "Puntaje FICO",
    y = "Densidad"
  ) +
  tema +
  theme(
    plot.title = element_text(face = "bold", size = 14, color = "#1b4332"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  )

p_fico


```


comentario fico



```{r p_monto}
p_monto_hist <- ggplot(lending_base, aes(x = monto_prestamo)) +
  geom_histogram(binwidth = 1000,
                 fill = "#2a9d8f",  
                 color = "white",
                 alpha = 0.9) +
  geom_vline(aes(xintercept = median(monto_prestamo, na.rm = TRUE)),
             color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = dollar_format(prefix = "$", big.mark = ",")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    title = "Distribución del monto del préstamo (mediana en rojo)",
    x = "Monto del préstamo (USD)",
    y = "Frecuencia"
  ) +
  tema
p_monto_hist

```

comentario monto

titulo3
Comparación entre clases (Paga vs No_paga)

```{r fico_dti_simplificado}

set.seed(123)

sample_plot <- lending_base %>% sample_n(min(8000, nrow(.)))

p_fico_dti <- ggplot(sample_plot, aes(x = puntaje_fico, y = relacion_deuda_ingreso)) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    color = "#1b4332",
    fill = "#95d5b2",
    linewidth = 1.2,
    alpha = 0.3
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_x_continuous(breaks = seq(600, 850, 25)) +
  labs(
    title = "Relación entre puntaje FICO y relación deuda/ingreso",
    
    x = "Puntaje FICO",
    y = "Relación deuda/ingreso (%)"
  ) +
  tema +
  theme(
    legend.position = "none",
    plot.subtitle = element_text(size = 11, color = "#555"),
    panel.grid.minor = element_blank()
  )

p_fico_dti

```


```{r montovsingresos}
corr_val <- cor(lending_base$ingreso, lending_base$monto_prestamo, use = "complete.obs")

p_monto <- ggplot(lending_base, aes(x = ingreso, y = monto_prestamo)) +
  geom_point(aes(color = estado_pago),
             alpha = 0.35, size = 1.4) +
  geom_smooth(
    method = "gam",
    formula = y ~ s(x, bs = "cs"),
    color = "#264653",
    fill = "#a8dadc",
    size = 1,
    se = TRUE
  ) +
  scale_x_continuous(
    labels = dollar_format(prefix = "$", big.mark = ","),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = dollar_format(prefix = "$", big.mark = ","),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_color_manual(
    values = c("Paga" = "#2a9d8f", "No_paga" = "#e76f51"),
    name = "Estado de pago"
  ) +
  labs(
    title = "Relación entre ingreso y monto del préstamo",
     round(corr_val, 2)),
    x = "Ingreso del solicitante (USD)",
    y = "Monto del préstamo (USD)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", color = "#1d3557"),
    plot.subtitle = element_text(color = "#457b9d"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),
    plot.margin = margin(10, 15, 10, 15)
  )

p_monto
```

## Distribución de las variables principales
## Caracterización de las clases
## Comportamiento según propósito del préstamo
# Modelos de clasificación
## División de los datos

Para el desarrollo de los modelos de clasificación, se realizó un muestreo estratificado balanceado seguido de una partición aleatoria, con el objetivo de mitigar el desbalance inherente en el dataset original de Lending Club, donde aproximadamente el 82% de las observaciones corresponden a préstamos pagados y solo el 18% a incumplimientos, lo que podría sesgar los algoritmos hacia la clase mayoritaria. Inicialmente, de la base filtrada y limpia ("lending_base"), se extrajo una muestra aleatoria de 10,000 observaciones utilizando sample_n() en R con semilla fija (set.seed(28)) para reproducibilidad: 5,000 de la clase "Paga" y 5,000 de "No_paga", aplicando undersampling a la clase dominante para igualar las proporciones y mejorar la sensibilidad de los modelos en la detección de riesgos crediticios. Esta técnica de balanceo es estándar en problemas de clasificación binaria desbalanceada, como los de préstamos P2P, ya que permite evaluaciones más robustas de métricas como precisión, recall y AUC sin requerir oversampling sintético.

Posteriormente, la muestra balanceada ("lending_muestra") se dividió en subconjuntos de entrenamiento (75% de las observaciones, equivalente a 7,500 registros) y prueba (25%, o 2,500 registros), utilizando sample() con la misma semilla para mantener la aleatoriedad controlada y preservar el equilibrio equitativo entre clases en ambos conjuntos (aproximadamente 50% "Paga" y 50% "No_paga"). La proporción 75/25 es una convención común en machine learning para clasificación, ya que proporciona suficientes datos para el entrenamiento mientras reserva un conjunto de prueba independiente para validar el rendimiento generalizado, evitando sobreajuste en datasets de riesgo crediticio como el de Lending Club. Esta división se implementó mediante índices aleatorios (index_entrena e index_test), asegurando que las variables predictoras (numéricas y categóricas) se mantuvieran representativas en ambos subconjuntos para una evaluación imparcial de los modelos KNN y logit.

## Modelo KNN

El modelo K-Nearest Neighbors (KNN) es un algoritmo de aprendizaje supervisado no paramétrico, ampliamente utilizado para problemas de clasificación, donde predice la clase de un nuevo punto de datos basándose en la mayoría de clases de sus k vecinos más cercanos en el espacio de características. Este método opera de manera "perezosa", ya que no construye un modelo explícito durante el entrenamiento, sino que almacena el conjunto de datos y realiza cálculos de distancia (como la euclidiana) solo en el momento de la predicción, lo que lo hace simple e intuitivo para capturar patrones locales en los datos.

### Modelo KNN (class)

El modelo KNN fue entrenado utilizando únicamente variables numéricas estandarizadas 
(`ingreso`, `relación deuda/ingreso`, `monto del préstamo`, y `puntaje FICO`).  
Se evaluaron diferentes valores de *k* (número de vecinos)

### Modelo KNN (caret)
## Modelo Logit

El modelo de regresión logística (logit) es un algoritmo de aprendizaje supervisado paramétrico diseñado principalmente para clasificación binaria, que estima la probabilidad de que una observación pertenezca a una clase específica (por ejemplo, pago o no pago) mediante la aplicación de la función sigmoide a una combinación lineal de las variables predictoras. A diferencia de la regresión lineal, transforma las salidas en valores entre 0 y 1, permitiendo interpretaciones probabilísticas y umbrales para decisiones de clasificación, lo que lo hace ideal para modelar relaciones no lineales en datos categóricos.


# Comparación de modelos
# Conclusiones 
# Bibliografia 
rfirawvjbkwbj
```{r setup, include=FALSE}



knitr::opts_chunk$set(echo = TRUE)
```

```{r cars}
```



```{r pressure, echo=FALSE}
```

