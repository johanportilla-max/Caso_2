---
title: "Comparación de Modelos de Clasificación Supervisada para la Predicción de Riesgo de Incumplimiento en Préstamos Personales: Un Análisis con K-Vecinos Más Cercanos y Regresión Logística."
author: |
  **Autores:**  
  Barros Rayo Alejandro (2415837),  
  Muñoz Portela Diego Fernando (2415620),  
  Portilla Aguirre Johan Camilo (2422468),  
  Aguirre Aldana Joan Sebastian (2419550)
output: 
  html_document:
    theme: lumen
    highlight: textmate
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    number_sections: true
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

```{=html}
<style type="text/css">
/* RESET COMPLETO */
* {
    box-sizing: border-box !important;
    max-width: 100% !important; /* CLAVE PARA EVITAR CORTES */
}

/* PALETA DE COLORES ELEGANTE */
:root {
  --primary-color: #1a365d;
  --secondary-color: #2d3748;
  --accent-color: #2b6cb0;
  --accent-light: #4299e1;
  --text-color: #2d3748;
  --light-bg: #f7fafc;
  --border-color: #e2e8f0;
  --shadow-light: rgba(0,0,0,0.06);
  --sidebar-width: 280px;
}

/* ESTRUCTURA BASE - ARREGLADA */
html, body {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100vw !important; /* EVITA SCROLL HORIZONTAL */
}

body {
    margin: 0 auto !important;
    padding: 0 !important;
    font-family: "Georgia", "Palatino Linotype", "Book Antiqua", serif !important;
    line-height: 1.75 !important;
    color: var(--text-color) !important;
    background: #f8f9fa !important;
}

/* CONTENEDOR PRINCIPAL */
.container-fluid, .main-container {
    max-width: 1600px !important; /* AUMENTADO */
    width: 100% !important;
    margin: 0 auto !important;
    padding: 20px !important;
    overflow-x: hidden !important;
}

/* LAYOUT CON SIDEBAR */
.row {
    display: flex !important;
    flex-wrap: nowrap !important;
    gap: 25px !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* TOC LATERAL - STICKY MEJORADO */
#TOC {
    background: white !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    padding: 25px !important;
    box-shadow: 0 2px 15px var(--shadow-light) !important;
    font-family: "Times New Roman", serif !important;
    width: var(--sidebar-width) !important;
    min-width: var(--sidebar-width) !important;
    max-width: var(--sidebar-width) !important;
    position: -webkit-sticky !important; /* Safari */
    position: sticky !important;
    top: 20px !important;
    align-self: flex-start !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    flex-shrink: 0 !important;
    max-height: calc(100vh - 40px) !important;
    z-index: 100 !important; /* IMPORTANTE */
}
#TOC::-webkit-scrollbar {
    width: 6px !important;
}

#TOC::-webkit-scrollbar-track {
    background: #f1f1f1 !important;
    border-radius: 3px !important;
}

#TOC::-webkit-scrollbar-thumb {
    background: var(--accent-light) !important;
    border-radius: 3px !important;
}

#TOC::before {
    content: "Índice de Contenidos" !important;
    display: block !important;
    font-family: "Times New Roman", serif !important;
    font-size: 1.3em !important;
    font-weight: bold !important;
    color: var(--primary-color) !important;
    border-bottom: 2px solid var(--accent-color) !important;
    padding-bottom: 12px !important;
    margin-bottom: 20px !important;
    position: sticky !important;
    top: 0 !important;
    background: white !important;
    z-index: 2 !important;
}

#TOC ul {
    list-style: none !important;
    padding-left: 0 !important;
    margin: 0 !important;
    width: 100% !important;
}

#TOC li {
    margin: 6px 0 !important;
    width: 100% !important;
}

#TOC a {
    color: var(--text-color) !important;
    text-decoration: none !important;
    font-size: 0.9em !important;
    display: block !important;
    padding: 8px 12px !important;
    border-left: 3px solid transparent !important;
    transition: all 0.3s ease !important;
    border-radius: 4px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
}

#TOC a:hover {
    color: var(--accent-color) !important;
    background-color: var(--light-bg) !important;
    border-left: 3px solid var(--accent-color) !important;
    padding-left: 15px !important;
}

#TOC .toc-section-number {
    color: var(--accent-color) !important;
    font-weight: 600 !important;
    margin-right: 6px !important;
}

#TOC ul ul {
    padding-left: 18px !important;
    margin-top: 4px !important;
}

#TOC ul ul a {
    font-size: 0.85em !important;
    color: #666666 !important;
}


/* CONTENIDO PRINCIPAL - ARREGLADO */
.toc-content, #content, .col-md-9 {
    flex: 1 !important;
    min-width: 0 !important; /* IMPORTANTE */
    width: 100% !important;
    max-width: calc(100% - var(--sidebar-width) - 25px) !important; /* CLAVE */
    padding: 40px !important;
    background: white !important;
    box-shadow: 0 0 20px var(--shadow-light) !important;
    border-radius: 8px !important;
    overflow: visible !important;
}

/* ASEGURAR QUE EL CONTENEDOR PADRE PERMITA STICKY */
.row, .container-fluid, .main-container {
    position: relative !important;
    overflow: visible !important;
}

/* COL-SM-3 (contenedor del TOC) */
.col-sm-3 {
    position: relative !important;
    height: fit-content !important;
}

/* SECCIONES */
.section, .section.level1, .section.level2 {
    margin-bottom: 40px !important;
    padding: 30px !important;
    background: white !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 8px var(--shadow-light) !important;
    width: 100% !important;
    max-width: 100% !important;
    overflow: visible !important;
}

/* TIPOGRAFÍA */
h1, h2, h3, h4, h5, h6 {
    font-family: "Times New Roman", "Times", serif !important;
    font-weight: 600 !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
}

h1 {
    color: var(--primary-color) !important;
    border-bottom: 3px double var(--accent-color) !important;
    padding-bottom: 20px !important;
    font-size: 2.2em !important;
    margin-bottom: 30px !important;
    text-align: center !important;
}

h1.title {
    font-size: 2em !important;
    line-height: 1.3 !important;
    margin-bottom: 15px !important;
}

h2 {
    color: var(--primary-color) !important;
    border-bottom: 2px solid var(--accent-light) !important;
    padding-bottom: 12px !important;
    font-size: 1.8em !important;
    margin-top: 35px !important;
    margin-bottom: 20px !important;
    padding-left: 15px !important;
    border-left: 4px solid var(--accent-color) !important;
}

h3 {
    color: var(--secondary-color) !important;
    font-size: 1.4em !important;
    margin-top: 25px !important;
    margin-bottom: 15px !important;
    padding-left: 10px !important;
    border-left: 3px solid var(--border-color) !important;
}

/* PÁRRAFOS */
p {
    text-align: justify !important;
    text-justify: inter-word !important;
    hyphens: auto !important;
    margin-bottom: 18px !important;
    line-height: 1.8 !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* ABSTRACT */
.abstract {
    background: linear-gradient(135deg, var(--light-bg) 0%, #edf2f7 100%) !important;
    padding: 30px 35px !important;
    border-left: 5px solid var(--accent-color) !important;
    margin-bottom: 35px !important;
    font-size: 1.05em !important;
    line-height: 1.8 !important;
    border-radius: 0 8px 8px 0 !important;
}

/* TABLAS - ARREGLADAS */
table {
    width: 100% !important;
    max-width: 100% !important;
    border-collapse: collapse !important;
    margin: 25px auto !important;
    font-size: 0.9em !important;
    box-shadow: 0 1px 6px var(--shadow-light) !important;
    border-radius: 6px !important;
    overflow-x: auto !important;
    display: block !important;
}

.table-responsive {
    width: 100% !important;
    overflow-x: auto !important;
}

th {
    background: linear-gradient(135deg, var(--primary-color) 0%, #2d3748 100%) !important;
    color: white !important;
    padding: 12px 14px !important;
    text-align: left !important;
    font-weight: 600 !important;
}

td {
    padding: 10px 14px !important;
    border-bottom: 1px solid var(--border-color) !important;
    background: white !important;
}

/* IMÁGENES Y GRÁFICOS - ARREGLADOS */
img, .figure img, .plot {
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
    margin: 20px auto !important;
}

.figure {
    text-align: center !important;
    margin: 30px 0 !important;
    padding: 20px !important;
    background: white !important;
    border-radius: 8px !important;
    box-shadow: 0 1px 6px var(--shadow-light) !important;
    border: 1px solid var(--border-color) !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* CÓDIGO */
pre {
    background: #1a202c !important;
    border-left: 4px solid var(--accent-color) !important;
    padding: 18px !important;
    border-radius: 0 6px 6px 0 !important;
    color: #e2e8f0 !important;
    margin: 20px 0 !important;
    overflow-x: auto !important;
    max-width: 100% !important;
}

code {
    background: #edf2f7 !important;
    color: #2b6cb0 !important;
    padding: 3px 6px !important;
    border-radius: 4px !important;
    word-wrap: break-word !important;
}

/* ENLACES */
a {
    color: var(--accent-color) !important;
    text-decoration: none !important;
    word-wrap: break-word !important;
}

a:hover {
    color: var(--primary-color) !important;
    text-decoration: underline !important;
}

/* RESPONSIVE */
@media (max-width: 1200px) {
    .row {
        flex-direction: column !important;
    }
    
    #TOC {
        width: 100% !important;
        max-width: 100% !important;
        position: relative !important;
        top: 0 !important;
        margin-bottom: 20px !important;
        max-height: 400px !important;
    }
    
    .toc-content, #content, .col-md-9 {
        max-width: 100% !important;
        width: 100% !important;
        padding: 30px !important;
    }
}

@media (max-width: 768px) {
    .container-fluid, .main-container {
        padding: 10px !important;
    }
    
    .toc-content, #content {
        padding: 20px !important;
    }
    
    .section, .section.level1 {
        padding: 20px !important;
    }
    
    h1 {
        font-size: 1.8em !important;
    }
    
    h2 {
        font-size: 1.5em !important;
    }
    
    table {
        font-size: 0.8em !important;
    }
}

/* SCROLL SUAVE */
html {
    scroll-behavior: smooth !important;
}

/* SECCIÓN ACTIVA EN TOC */
#TOC a.active {
    color: var(--accent-color) !important;
    background-color: var(--light-bg) !important;
    border-left: 3px solid var(--accent-color) !important;
    font-weight: 600 !important;
}
</style>
```

# Introducción

Una correcta evaluación del riesgo crediticio termina siendo un pilar fundamental en la gestión financiera moderna.
Es por esto que en contextos de otorgamiento masivo de préstamos la capacidad para diferenciar con precisión entre solicitantes de bajo y alto riesgo de incumplimiento determina, en gran medida, la sostenibilidad de la cartera y la rentabilidad de la entidad.
Los procesos de crédito han evolucionado hacia procedimientos fundamentados en modelos estadísticos y algoritmos de aprendizaje automático, permitiendo decisiones más objetivas, replicables y escalables.

Lending Club es una plataforma de crédito en línea que funciona como un mercado (peer-to-peer) para el otorgamiento de préstamos personales, conectando directamente a solicitantes con inversionistas.
Mediante procesos digitales estándar, la plataforma recopila información proporcionada por el solicitante (como lo pueden ser ingresos, propósito del préstamo, puntajes crediticios, entre otros) y emplea reglas y modelos de evaluación de riesgo para decidir la aprobación y las condiciones del préstamo.
La disponibilidad pública de historiales de préstamos originados en esta plataforma ha convertido a sus bases de datos en una fuente de referencia para la investigación en scoring crediticio y modelado del incumplimiento, permitiendo analizar patrones de morosidad y evaluar algoritmos de clasificación aplicables a procesos operativos de riesgo.

En este trabajo se emplea esta base de datos pública (Lending Club) como insumo para un ejercicio de clasificación supervisada, cuyo propósito es estimar la probabilidad de incumplimiento de préstamos personales.
El análisis toma como referencia solicitudes reales registradas en la plataforma y se centra en información disponible al momento de la decisión crediticia, con el fin de reproducir condiciones operativas reales de otorgamiento.
Este enfoque permite estudiar la capacidad predictiva de modelos estadísticos clásicos (regresión logística) frente a algoritmos basados en instancias (KNN), así como evaluar su aplicabilidad práctica en escenarios de scoring crediticio.

La importancia de clasificar de manera adecuada el riesgo de incumplimiento es múltiple.
En primer lugar, reduce la exposición a pérdidas por préstamos morosos y optimiza el balance entre aceptación y rechazo de solicitudes, mejorando la rentabilidad ajustada por riesgo.
En segundo lugar, una clasificación robusta contribuye a la inclusión financiera responsable; ya que, al identificar correctamente perfiles de riesgo, las entidades pueden diseñar productos y precios diferenciados que incentiven el acceso al crédito sin comprometer la sostenibilidad.
Por último, la transparencia e interpretabilidad de los modelos (especialmente relevante en entornos regulatorios) facilita la auditoría de decisiones y la incorporación de salvaguardas frente a sesgos sistémicos.

El presente estudio tuvo como propósito desarrollar y comparar modelos de clasificación supervisada que permitieran predecir el riesgo de incumplimiento en préstamos personales, con el fin de aportar evidencia técnica para la toma de decisiones de crédito basadas en datos.
Desde un punto de vista metodológico general, el estudio adopta el paradigma del aprendizaje supervisado: se ajustan modelos sobre un subconjunto de observaciones con estado conocido (pagado / incumplido) y se evalúa su desempeño en datos independientes.
La comparación entre regresión logística y KNN se orienta a contrastar dos aproximaciones distintas: una paramétrica y fácilmente interpretable (logit) frente a una no paramétrica basada en proximidad en el espacio de características (KNN).
La evaluación se realiza mediante métricas de clasificación estándares (exactitud, sensibilidad, especificidad) y métricas de discriminación (AUC de la curva ROC), y se complementa con validación cruzada y búsqueda de hiperparámetros para garantizar robustez en la selección de modelos. Los resultados serán interpretados en términos estadísticos.

# Metodología

El presente estudio siguió un enfoque de aprendizaje supervisado orientado a la clasificación binaria (paga / no_paga).
El procedimiento general consistió en aplicar dos familias de clasificadores (regresión logística paramétrica y K-Vecinos Más Cercanos no paramétrico) sobre datos previamente preparados, y evaluar su desempeño mediante métricas complementarias y procedimientos de validación.

La implementación se realizó en R empleando flujos estandarizados de preprocesamiento y modelado.
Para reducir la influencia de escalas dispares y valores extremos, se aplicaron filtros sobre outliers relevantes y se normalizaron las variables numéricas (centrado y escala) cuando correspondió; dicho escalado fue especialmente crítico para KNN, dada su dependencia de distancias euclidianas. La muestra final fue construida de forma estratificada para asegurar balance entre las clases objetivo, y todas las operaciones aleatorias (muestreo y particionado); además, se fijó la semilla `set.seed(28)` para garantizar reproducibilidad.

En cuanto al ajuste de modelos, la regresión logística se estimó mediante glm(..., family = binomial()), obteniendo probabilidades predictivas que permitieron tanto el análisis de coeficientes como la construcción de curvas ROC y la determinación de umbrales operativos (índice de Youden). El KNN se abordó de dos maneras; una implementación básica con `class::knn`, evaluando k en un rango (k = 1:100) y seleccionando el k que maximizó la exactitud fuera de muestra; y una versión integrada en `caret::train()` que incorporó validación cruzada estratificada (5 folds), búsqueda automática de hiperparámetros `tuneLength` y optimización según el AUC (métrica ROC), lo que permitió una selección de modelo más robusta frente a la variabilidad de los datos.

```{r sep, echo = FALSE, warning = FALSE, message = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(tidyr)
library(readr)
library(tidyverse)
library(class)
library(caret)
library(pROC)
library(ggthemes)
library(lubridate)
library(kableExtra)
library(knitr)
library(ggcorrplot)
library(scales)
library(gridExtra)
library(grid)
library(ggplotify)
library(broom)

```

## Fuente de datos

Para el presente trabajo se utiliza la base de datos pública Lending Club Loan Data (2007–2018) descargada desde Zenodo.
La base de datos fue depurada y filtrada para mantener únicamente las observaciones y variables disponibles al momento de la decisión crediticia, con el objetivo de reproducir condiciones operativas reales en un ejercicio de scoring.
En el proceso de limpieza se aplicaron filtros sobre valores extremos y se eliminaron las observaciones con valores faltantes en las variables de interés.
Además, se construyó una muestra balanceada y reproducible compuesta por 10.000 observaciones (5.000 préstamos pagados y 5.000 préstamos en incumplimiento), a fin de evitar sesgos de clase en la estimación de los modelos.

## Definición de variables

Las variables utilizadas en el estudio se organizan en dos grupos: dependientes e independientes.
La variable dependiente seleccionada es el estado de pago de la persona (estado_pago), construida a partir del indicador Default y se codificó como factor con niveles “Paga” (no default) y “No_paga” (default).
Esta variable refleja el resultado del contrato crediticio y es una medida directa del riesgo de incumplimiento, por lo que su correcta definición y codificación es central para cualquier ejercicio de scoring, ya que no solo indica la ocurrencia del impago, sino que también sirve como referencia para estimar probabilidades de default y calibrar los umbrales de decisión en procesos de aprobación crediticia.

Entre las variables independientes se incorporaron predictores financieros y de propósito del préstamo que, según la teoría del riesgo y la práctica del credit scoring, guardan relación con la capacidad de pago y la propensión al incumplimiento.
El ingreso anual declarado por el solicitante `ingreso` se emplea como proxy de la capacidad de repago; a mayor ingreso disponible se espera una menor probabilidad de default, dado que permite absorber obligaciones adicionales y enfrentar eventos adversos sin perder la capacidad de servicio de la deuda.
No obstante, la medida declarativa del ingreso puede presentar sesgos por subdeclaración o variabilidad temporal, por lo que su interpretación debe hacerse con cuidado.

La relación deuda/ingreso `relacion_deuda_ingreso` sintetiza la carga financiera del solicitante al relacionar obligaciones vigentes con su ingreso.
Un DTI (Debt-to-Income, que viene siendo la relación deuda/ingreso) elevado indica que una fracción significativa del ingreso ya está comprometida con otras deudas, lo que incrementa la vulnerabilidad ante shocks y aumenta la probabilidad de incumplimiento.
Se toma en cuenta ya que permite captar no solo la magnitud del endeudamiento sino también la presión relativa sobre la liquidez del hogar o individuo.

El monto solicitado `monto_prestamo` incorpora la dimensión contractual del crédito, que son los préstamos de mayor cuantía: los cuales, sin ajustes proporcionales en condiciones o capacidad de pago, tienden a elevar el riesgo de default por aumentar la carga mensual y alargar el horizonte de exposición.
Además, el monto solicitado puede interactuar con otras variables (por ejemplo, ingreso o FICO) para dibujar perfiles diferenciados de riesgo.
Su inclusión facilita distinguir situaciones en las que un mismo monto resulta asumible o riesgoso según el contexto financiero del solicitante.

El puntaje crediticio `puntaje_fico` funciona como un indicador consolidado del historial crediticio y de la probabilidad observada de cumplimiento en períodos previos.
Puntajes más altos se asocian sistemáticamente con menor probabilidad de impago, pues reflejan comportamientos de pago estables, menor incidencia de morosidad previa y hábitos financieros más conservadores.
Por su carácter informativo y su uso extendido en la industria, el puntaje FICO aporta a la discriminación del riesgo y suele mostrar efectos significativos en modelos paramétricos y no paramétricos.

El propósito del préstamo reagrupado `proposito_agrupado` captura el destino del crédito, como lo puede ser una consolidación de deuda, compra de vivienda o vehículo, inversión en negocio, educación.
Refleja diferencias cualitativas en la naturaleza y prioridad del gasto.
Distintos propósitos implican perfiles de riesgo heterogéneos, es decir, un préstamo para consolidación de deuda puede indicar una situación financiera tensionada, mientras que un préstamo para inversión productiva o educación puede asociarse a retornos que faciliten el repago.

```{r Variables}

variables_modelo <- data.frame(
  Variable = c("estado_pago", "ingreso", "relacion_deuda_ingreso",
               "monto_prestamo", "puntaje_fico", "proposito_agrupado", "default_num"),
  
  Descripción = c(
    "Variable dependiente que representa el resultado final del crédito.",
    "Ingreso anual declarado por el solicitante, indicador de capacidad de pago.",
    "Ratio financiero que mide la carga de endeudamiento frente al ingreso.",
    "Valor del préstamo solicitado por el cliente.",
    "Puntaje crediticio que resume el historial de crédito del solicitante.",
    "Motivo declarado del préstamo, agrupado en categorías mayores.",
    "Versión numérica de la variable dependiente usada en el modelo Logit."
  ),
  
  Tipo_Variable = c(
    "Categórica (binaria)",
    "Cuantitativa continua",
    "Cuantitativa continua",
    "Cuantitativa continua",
    "Cuantitativa continua",
    "Categórica (agrupada)",
    "Binaria (numérica)"
  ),
  
  Ejemplos_Notas = c(
    "Ej: 'Paga', 'No_paga'.",
    "En dólares anuales.",
    "Proporción (ej. 0.35).",
    "Monto del préstamo en USD.",
    "Rango típico: 300 – 850.",
    "Ej: 'Consolidación', 'Negocio', 'Otros'.",
    "0 = Paga, 1 = No_paga."
  )
)

tabla_variables <- kable(
  variables_modelo,
  format = "html",
  col.names = c("Variable", "Descripción", "Tipo de Variable", "Ejemplos / Notas"),
  align = c('l', 'l', 'l', 'l'),
  caption = "Tabla 1. Variables utilizadas en el Modelo Logit"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "3cm") %>%
  column_spec(4, width = "3.5cm") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018).",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

tabla_variables
```

```{r tema2, echo = FALSE, warning = FALSE, message = FALSE}
tema <- theme_minimal() +
  theme(
    text = element_text(family = "Segoe UI", color = "#2d3748"),
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, color = "#323130"),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "#605e5c", margin = margin(b = 15)),
    plot.caption = element_text(size = 10, color = "#605e5c", hjust = 0),
    panel.grid.major = element_line(color = "#f3f2f1"),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    axis.title = element_text(face = "bold", color = "#323130"),
    axis.text = element_text(color = "#605e5c"),
    legend.position = "none"
  )
```

## Preparación y limpieza de datos

```{r carga_datos, echo = FALSE, warning = FALSE, message = FALSE}

lending_raw <- read_csv("LC_loans_granting_model_dataset.csv", guess_max = 20000)

lending_base <- lending_raw %>%
  select(revenue, dti_n, loan_amnt, fico_n, Default, purpose, issue_d) %>%
  rename(
    ingreso = revenue,
    relacion_deuda_ingreso = dti_n,
    monto_prestamo = loan_amnt,
    puntaje_fico = fico_n,
    estado_pago = Default,
    proposito = purpose
  ) %>%
  mutate(
    fecha_emision = parse_date_time(issue_d, orders = "b-Y", locale = "en_US"),
    Año = year(fecha_emision),
    proposito = as.factor(proposito),
    proposito_agrupado = fct_collapse(
      proposito,
      Consolidacion = c("debt_consolidation", "credit_card"),
      Casa_Vehiculo = c("home_improvement", "major_purchase", "car", "house"),
      Negocio_Estudio = c("small_business", "educational")
    ),
    proposito_agrupado = fct_other(
      proposito_agrupado,
      keep = c("Consolidacion", "Casa_Vehiculo", "Negocio_Estudio"),
      other_level = "Otros"
    ),
    estado_pago = fct_recode(as.factor(estado_pago), "Paga" = "0", "No_paga" = "1")
  ) %>%
  select(-proposito)

lending_completa <- lending_base

lending_base <- lending_base %>%
  filter(ingreso <= 250000, relacion_deuda_ingreso <= 50) %>%
  drop_na()

set.seed(28)
paga <- lending_base %>% filter(estado_pago == "Paga") %>% sample_n(5000)
nopaga <- lending_base %>% filter(estado_pago == "No_paga") %>% sample_n(5000)
lending_muestra <- bind_rows(paga, nopaga) %>% arrange(sample(1:n()))

lending_base <- lending_muestra

```

A partir de la base original descargada desde Zenodo, se seleccionaron únicamente las variables disponibles al momento de la decisión crediticia y relevantes para el objetivo de clasificación: ingreso anual `revenue`, relación deuda/ingreso `dti_n`, monto del préstamo `loan_amnt`, puntaje crediticio FICO `fico_n`, indicador de incumplimiento `Default`, propósito del préstamo `purpose` y fecha de emisión `issue_d`.
Estas variables fueron renombradas empleando nomenclatura descriptiva en español para facilitar la interpretación de resultados.

La variable dependiente `Default` (originalmente codificada como 0/1) se transformó a factor con niveles "Paga" y "No_paga", estableciendo de forma explícita la clase de interés para las métricas de evaluación.
La variable `purpose` (propósito del préstamo), que contenía múltiples categorías detalladas, fue reagrupada mediante `fct_collapse()` en cuatro categorías más generales y operativamente interpretables: "Consolidacion" (consolidación de deuda y tarjetas de crédito), "Casa_Vehiculo" (mejoras al hogar, compras mayores, vehículos y vivienda), "Negocio_Estudio" (pequeños negocios y educación) y "Otros" (propósitos residuales).
Esta reagrupación buscó reducir la dispersión categórica y concentrar la señal predictiva en grupos conceptualmente coherentes.

```{r Ingreso}

ggplot(lending_raw, aes(x = revenue)) +
  geom_histogram(
    binwidth = 25000,
    fill = "#90caf9",    # azul suave
    color = "#1a5276",   # borde azul oscuro
    alpha = 0.9
  ) +
  geom_vline(
    xintercept = 250000,
    linetype = "dashed",
    color = "#c0392b",
    linewidth = 1
  ) +
  xlim(0, 500000) +
  labs(
    title = "Distribución del Ingreso Anual de los Solicitantes",
    subtitle = "Filtro aplicado: ingresos superiores a 250,000 USD se consideran atípicos",
    x = "Ingreso anual (USD)",
    y = "Frecuencia",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)."
  ) +
  tema +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5, color = "#2c3e50"),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "#34495e"),
    axis.title = element_text(face = "bold", size = 12, color = "#2c3e50"),
    axis.text = element_text(size = 10, color = "#34495e"),
    plot.caption = element_text(size = 9, hjust = 0.5, color = "#7f8c8d")
  )

```

```{r D.ingreso}

ggplot(lending_raw, aes(x = dti_n)) +
  geom_histogram(
    binwidth = 5,
    fill = "#1a5276",    
    color = "#1a5276",   
    alpha = 0.9
  ) +
  geom_vline(
    xintercept = 50,
    linetype = "dashed",
    color = "#c0392b",
    linewidth = 1
  ) +
  xlim(0, 100) +
  labs(
    title = "Distribución de la Relación Deuda–Ingreso (DTI)",
    subtitle = "Filtro aplicado: DTI superiores a 50 se consideran valores atípicos",
    x = "Relación Deuda/Ingreso (%)",
    y = "Frecuencia",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)."
  ) +
  tema +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5, color = "#2c3e50"),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "#34495e"),
    axis.title = element_text(face = "bold", size = 12, color = "#2c3e50"),
    axis.text = element_text(size = 10, color = "#34495e"),
    plot.caption = element_text(size = 9, hjust = 0.5, color = "#7f8c8d")
  )

```

Con base en la exploración gráfica de las distribuciones (histogramas de ingreso y DTI), se identificaron valores extremos que podían distorsionar la estimación de los modelos o reflejar errores de registro.
Se aplicaron dos filtros: se excluyeron registros con ingresos anuales superiores a 250,000 dólares (aproximadamente el percentil 99), y se eliminaron observaciones con relación deuda/ingreso mayor a 50 (casos de sobreendeudamiento extremo o datos inconsistentes).
Estos umbrales fueron definidos mediante inspección visual de las distribuciones y considerando criterios de plausibilidad financiera.
El filtrado permitió reducir la influencia de outliers sin comprometer la representatividad de la muestra.

Tratamiento de valores faltantes: Una vez aplicados los filtros, se eliminaron todas las observaciones con valores faltantes (drop_na()) en cualquiera de las variables seleccionadas.
Esta decisión se fundamentó en la necesidad de trabajar con registros completos para garantizar comparabilidad entre modelos y evitar imputaciones que pudieran introducir sesgos.
Dado el tamaño original de la base, la eliminación de casos incompletos no comprometió la disponibilidad de datos para el modelado.

## Distribución de frecuencias por estado de pago

```{r tabla_frecuencias}
tabla_estado <- as.data.frame(table(lending_raw$Default))
colnames(tabla_estado) <- c("estado_pago", "n")
tabla_estado$porcentaje <- round(prop.table(tabla_estado$n) * 100, 2)
tabla_estado$estado_pago <- ifelse(
  tabla_estado$estado_pago == 0, 
  "Paga", 
  "No_paga"
)

tabla_estado %>%
  kbl(
    caption = "Distribución de Frecuencias por Estado de Pago en la base original",
    align = c("l", "r", "r"),
    col.names = c("Estado Pago", "Frecuencia", "Porcentaje (%)")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2:3, width = "2.5cm") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en datos de Lending Club",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )
```

Para evitar sesgos de clase en la estimación (la base filtrada presentaba desbalance entre pagos e incumplimientos), se construyó una muestra estratificada de 10,000 observaciones: 5,000 préstamos con estado "Paga" y 5,000 con estado "No_paga". El muestreo aleatorio dentro de cada clase se realizó con semilla fija `set.seed(28)` para garantizar reproducibilidad. Esta estrategia de balanceo permite que los modelos aprendan con igual representación de ambas clases, mejorando la sensibilidad frente al incumplimiento sin comprometer la especificidad. A partir de este punto, todos los análisis descriptivos y modelos se realizan sobre esta muestra balanceada.

# Análisis descriptivo

El conjunto de datos analizado corresponde a registros de préstamos otorgados por la plataforma Lending Club, e incluye información relevante sobre las características financieras de los solicitantes y el comportamiento de pago asociado a cada crédito.
Con el fin de comprender de manera preliminar la composición y variabilidad de las observaciones, se presenta a continuación un resumen de las principales estadísticas descriptivas y la distribución de frecuencias por estado de pago.

```{r resumen_general, echo = FALSE, warning = FALSE, message = FALSE}

resumen_general <- lending_base %>%
  select(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico) %>%
  summarise_all(list(
    n = ~sum(!is.na(.)),
    media = ~mean(., na.rm = TRUE),
    mediana = ~median(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE),
    minimo = ~min(., na.rm = TRUE),
    maximo = ~max(., na.rm = TRUE)
  )) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("variable", ".value"),
    names_pattern = "^(.*)_(n|media|mediana|sd|minimo|maximo)$"
  )
```

## Estadísticas descriptivas de las variables principales

```{r tabla_resumen }
tabla_resumen <- resumen_general %>%
  select(-n) %>%
  mutate(
    Variable = recode(
      variable,
      ingreso = "Ingreso",
      relacion_deuda_ingreso = "Relación deuda-ingreso",
      monto_prestamo = "Monto del préstamo",
      puntaje_fico = "Puntaje FICO"
    ),
    Media = comma(Media, accuracy = 0.01),
    Mediana = comma(Mediana, accuracy = 0.01),
    `Desv. Estándar` = comma(Desv_Estandar, accuracy = 0.01),
    Mínimo = comma(Mínimo, accuracy = 0.01),
    Máximo = comma(Máximo, accuracy = 0.01)
  ) %>%
  select(Variable, Media, Mediana, `Desv. Estándar`, Mínimo, Máximo)

tabla_resumen %>%
  kable(
    format = "html",
    col.names = c("Variable", "Media", "Mediana", "Desv. Estándar", "Mínimo", "Máximo"),
    align = c('l', 'r', 'r', 'r', 'r', 'r'),
    caption = "Tabla 1: Estadísticas Descriptivas de las Variables Principales del Dataset de Préstamos"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3.5cm") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en datos de Lending Club",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

tabla_resumen
```

La Tabla 1 resume las medidas de tendencia central y dispersión de las variables cuantitativas incluidas en el estudio.
En promedio, los solicitantes reportan un ingreso anual de USD 73,988, con una mediana de USD 65,000, lo que sugiere una ligera asimetría positiva en la distribución, reflejando la presencia de algunos ingresos excepcionalmente altos que elevan el promedio.

La relación deuda/ingreso presenta una media de 18.4%, indicando que, en promedio, los deudores destinan cerca de una quinta parte de sus ingresos al pago de obligaciones financieras.
No obstante, el rango entre 0% y 50% evidencia una amplia heterogeneidad en los niveles de endeudamiento entre los solicitantes.

El monto promedio de los préstamos asciende a USD 14,360, con una desviación estándar de aproximadamente USD 8,645, lo que denota variabilidad significativa en los montos solicitados, posiblemente asociada a diferencias en capacidad de pago o propósito del crédito.

Por su parte, el puntaje FICO, que refleja el historial crediticio de los solicitantes, presenta una media de 697 puntos, situándose dentro de la categoría de “buen crédito”.
Su baja desviación estándar (31.7) indica una distribución relativamente concentrada, lo que sugiere que la mayoría de los clientes poseen un perfil crediticio estable.

En conjunto, estas estadísticas evidencian una población de solicitantes con ingresos moderados a altos, niveles de endeudamiento diversos y un comportamiento crediticio predominantemente positivo.

## Distribución individual de variables numéricas

### Histograma del ingreso

```{r p1}
library(plotly)

p1 <- ggplot(lending_base, aes(x = ingreso)) +
  geom_histogram(binwidth = 5000,
                 fill = "#2b6cb0",
                 color = "white",
                 alpha = 0.8) +
  geom_vline(xintercept = median(lending_base$ingreso, na.rm = TRUE),
             color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = scales::dollar_format(prefix = "$", big.mark = ",")) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    x = "Ingreso",
    y = "Frecuencia"
  ) +
  tema
p1

```

La Figura 1 presenta la distribución de la variable ingreso anual de los solicitantes de préstamo.
El histograma evidencia una asimetría positiva, donde la mayoría de los individuos reportan ingresos entre USD 40,000 y USD 80,000, mientras que un grupo reducido alcanza valores considerablemente más altos, superiores a los USD 150,000.

La línea roja punteada indica la mediana, ubicada alrededor de USD 65,000, lo cual coincide con la tendencia central observada en la tabla descriptiva.
Esta concentración en niveles intermedios de ingreso sugiere que la base de datos está compuesta principalmente por personas con capacidad de pago media, probablemente pertenecientes a segmentos laborales formales o con ingresos estables.

Los valores más altos de ingreso, aunque minoritarios, representan a solicitantes con mayor capacidad financiera, lo que puede influir positivamente en su probabilidad de aprobación y cumplimiento del crédito.
En conjunto, la distribución muestra una población heterogénea, pero con predominio de ingresos medios dentro del conjunto analizado.

### Distribución de la relación deuda/ingreso

```{r pdti}
p_dti <- ggplot(lending_base, aes(x = relacion_deuda_ingreso)) +
  geom_density(fill = "#2a9d8f",       
               color = "#1b4d47",      
               alpha = 0.4,
               size = 1.1) +
  geom_vline(aes(xintercept = median(relacion_deuda_ingreso, na.rm = TRUE)),
             color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(
    x = "Relación deuda/ingreso (%)",
    y = "Densidad"
  ) +
  tema

p_dti


```

La Figura 2 ilustra la densidad de la variable relación deuda/ingreso (%), la cual mide el nivel de endeudamiento de los solicitantes respecto a su capacidad económica.
La distribución presenta una forma ligeramente asimétrica hacia la derecha, con un claro punto de concentración entre los 10% y 25%, y una mediana cercana al 18% (línea roja punteada).

Esto indica que, en promedio, los solicitantes destinan menos de una quinta parte de sus ingresos al pago de deudas, lo que refleja niveles de endeudamiento controlados en la mayoría de los casos.
Sin embargo, se observan algunos valores altos por encima del 40% que corresponden a individuos con una carga financiera elevada, lo que puede representar un mayor riesgo de incumplimiento.

La forma suavizada del gráfico evidencia una distribución continua y bien concentrada, lo que sugiere que el comportamiento de esta variable sigue una tendencia general homogénea dentro de la población crediticia.

### Distribución del puntaje FICO

```{r fico}
p_fico <- ggplot(lending_base, aes(x = puntaje_fico)) +
  geom_density(
    bw = 15,                
    fill = "#52b788",       
    color = "#1b4332",      
    alpha = 0.8,
    size = 1.1
  ) +
  geom_vline(
    xintercept = median(lending_base$puntaje_fico, na.rm = TRUE),
    color = "#e63946", linetype = "dashed", size = 1
  ) +
  scale_x_continuous(
    breaks = seq(600, 850, 25),
    limits = c(600, 850)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::comma_format()
  ) +
  labs(
    x = "Puntaje FICO",
    y = "Densidad"
  ) +
  tema +
  theme(
    plot.title = element_text(face = "bold", size = 14, color = "#1b4332"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  )

p_fico


```

La distribución del puntaje FICO evidencia una clara concentración de valores entre 660 y 720 puntos, con una mediana cercana a 690 (línea roja).
Esto indica que la mayoría de los solicitantes poseen un historial crediticio considerado “bueno”, aunque no necesariamente “excelente”.
La distribución es ligeramente asimétrica hacia la derecha, lo cual refleja que existen prestatarios con puntajes altos (mayores a 750), pero en menor proporción.
Este comportamiento es esperable, dado que los puntajes más altos suelen corresponder a individuos con un historial crediticio más largo y estable.

### Distribución del monto del préstamo

```{r p_monto}
p_monto_hist <- ggplot(lending_base, aes(x = monto_prestamo)) +
  geom_histogram(binwidth = 1000,
                 fill = "#2a9d8f",  
                 color = "white",
                 alpha = 0.9) +
  geom_vline(aes(xintercept = median(monto_prestamo, na.rm = TRUE)),
             color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = dollar_format(prefix = "$", big.mark = ",")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    x = "Monto del préstamo (USD)",
    y = "Frecuencia"
  ) +
  tema
p_monto_hist

```

El histograma del monto solicitado en préstamo presenta una distribución dispersa, con una fuerte concentración de valores entre 5,000 y 15,000, y una mediana cercana a los 12,000.
Esto sugiere que la mayoría de los créditos aprobados corresponden a montos pequeños o medianos, probablemente asociados a consumo o consolidación de deudas.
Se observa también la presencia de montos más altos, aunque con menor frecuencia, lo cual es coherente con una política crediticia que limita el riesgo mediante montos moderados para la mayoría de los solicitantes.

## Puntaje FICO por estado de pago

```{r ficopagaono}
p_fico_box <- ggplot(lending_base, aes(x = estado_pago, y = puntaje_fico, fill = estado_pago)) +
geom_boxplot() +
labs(
x = "Estado de pago",
y = "Puntaje FICO"
) +
tema
print(p_fico_box)


```

El boxplot evidencia una diferencia notable en el puntaje FICO según el estado de pago.
Los prestatarios que pagan tienden a tener un FICO ligeramente superior, con una mediana cercana a los 700 puntos, mientras que quienes no pagan se concentran alrededor de 680–690 puntos.
Esta diferencia confirma que un mejor historial crediticio se asocia con un mayor cumplimiento en los pagos.

## ingreso por estado de pago

```{r ingresopaga on o paga}

p_box_ingreso <- ggplot(lending_base, aes(x = estado_pago, y = ingreso, fill = estado_pago)) +
geom_boxplot(alpha = 0.7, outlier.color = "gray40", outlier.alpha = 0.4) +
scale_fill_manual(values = c("Paga" = "#1b9e77", "No_paga" = "#d95f02")) +
scale_y_continuous(labels = scales::dollar_format(prefix = "$", big.mark = ",")) +
labs(
x = "Estado de pago",
y = "Ingreso (USD)"
) +
tema
p_box_ingreso
```

La comparación del ingreso por estado de pago revela que los prestatarios que cumplen con sus obligaciones presentan una mediana de ingreso ligeramente más alta que los morosos.
Aunque la dispersión en ambos grupos es amplia, se observa una mayor presencia de valores atípicos elevados en el grupo “Paga”, lo cual sugiere que los ingresos más altos se asocian con una mayor probabilidad de cumplimiento.

## Comparación de variables numéricas según estado de pago

```{r todasvariable}

p_comparativo <- lending_base %>%
pivot_longer(cols = c(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico),
names_to = "variable", values_to = "valor") %>%
ggplot(aes(x = estado_pago, y = valor, fill = estado_pago)) +
geom_boxplot(alpha = 0.6, outlier.alpha = 0.3) +
facet_wrap(~ variable, scales = "free", ncol = 2) +
scale_y_continuous(labels = comma) +
scale_fill_manual(values = c("Paga" = "#1b9e77", "No_paga" = "#d95f02")) +
labs(
x = "Estado de pago",
y = "Valor"
) +
tema
print(p_comparativo)
```

Conjuntamente, los boxplots sugieren un patrón coherente: mayor ingreso y mayor puntaje FICO actúan como factores protectores frente al incumplimiento, mientras que una mayor relación deuda/ingreso incrementa el riesgo.
El monto del préstamo por sí solo no explica totalmente el comportamiento (medianas similares), pero su mayor dispersión entre los morosos indica que créditos elevados en prestatarios vulnerables pueden agravar la probabilidad de default.
Para la gestión del riesgo crediticio estas observaciones implican: priorizar la evaluación de DTI y FICO en la toma de decisiones, contemplar límites o condiciones más estrictas para solicitudes con alta DTI, y considerar estrategias de segmentación donde el tamaño del préstamo se ajuste a la capacidad de pago observada.

## Relaciónes

### Relación entre puntaje FICO y relación deuda/ingreso

```{r fico_dti_simplificado}

set.seed(123)

sample_plot <- lending_base %>% sample_n(min(8000, nrow(.)))

p_fico_dti <- ggplot(sample_plot, aes(x = puntaje_fico, y = relacion_deuda_ingreso)) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    color = "#1b4332",
    fill = "#95d5b2",
    linewidth = 1.2,
    alpha = 0.3
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_x_continuous(breaks = seq(600, 850, 25)) +
  labs(
    
    x = "Puntaje FICO",
    y = "Relación deuda/ingreso (%)"
  ) +
  tema +
  theme(
    legend.position = "none",
    plot.subtitle = element_text(size = 11, color = "#555"),
    panel.grid.minor = element_blank()
  )

p_fico_dti

```

La curva muestra una relación inversa clara: a medida que el puntaje FICO aumenta, la proporción deuda/ingreso (DTI) tiende a disminuir .
Esto indica que los prestatarios con mejor historial crediticio manejan proporcionalmente menos deuda respecto a su ingreso, mientras que los puntajes medios-bajos concentran mayor carga financiera.
La mayor incertidumbre en los extremos del rango (colas más amplias) sugiere escasez de datos y mayor variabilidad en esos tramos.
En términos prácticos, el gráfico respalda usar FICO y DTI de forma conjunta para discriminar riesgo: perfiles con FICO bajo y DTI alto son candidatos de mayor riesgo, perfiles inversos, de menor riesgo.

### Relación entre ingreso y monto del préstamo

```{r montovsingresos}
corr_val <- cor(lending_base$ingreso, lending_base$monto_prestamo, use = "complete.obs")

p_monto <- ggplot(lending_base, aes(x = ingreso, y = monto_prestamo)) +
  geom_point(aes(color = estado_pago),
             alpha = 0.35, size = 1.4) +
  geom_smooth(
    method = "gam",
    formula = y ~ s(x, bs = "cs"),
    color = "#264653",
    fill = "#a8dadc",
    size = 1,
    se = TRUE
  ) +
  scale_x_continuous(
    labels = dollar_format(prefix = "$", big.mark = ","),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_y_continuous(
    labels = dollar_format(prefix = "$", big.mark = ","),
    expand = expansion(mult = c(0.02, 0.02))
  ) +
  scale_color_manual(
    values = c("Paga" = "#2a9d8f", "No_paga" = "#e76f51"),
    name = "Estado de pago"
  ) +
  labs(
    x = "Ingreso del solicitante (USD)",
    y = "Monto del préstamo (USD)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", color = "#1d3557"),
    plot.subtitle = element_text(color = "#457b9d"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),
    plot.margin = margin(10, 15, 10, 15)
  )

p_monto
```

El gráfico confirma que el ingreso es un predictor relevante del monto del préstamo —a mayor ingreso, mayor tendencia a recibir montos mayores— pero la relación es moderada y sujeta a límites operativos y a la influencia de otras variables crediticias.
Por tanto, las decisiones de crédito deben combinar información de ingreso con medidas de riesgo (DTI, FICO) y restricciones de producto para optimizar la asignación y minimizar el riesgo de default.

### Relación entre puntaje FICO y relación deuda/ingreso

```{r ficovsdti}

set.seed(123)
sample_plot <- lending_base %>% sample_n(min(10000, nrow(.)))

p_fico_dti_smooth <- ggplot(sample_plot, aes(x = puntaje_fico, y = relacion_deuda_ingreso)) +
geom_point(alpha = 0.05, size = 0.6, color = "#6baed6") +
geom_smooth(method = "loess", se = TRUE, color = "black", size = 1) +
scale_y_continuous(labels = percent_format(scale = 1)) +
labs(
x = "Puntaje FICO",
y = "Relación deuda/ingreso (%)"
) +
tema
print(p_fico_dti_smooth)

```

La gráfica muestra una tendencia inversa entre el puntaje FICO y la relación deuda/ingreso (DTI), lo que significa que, a medida que el puntaje FICO aumenta, la proporción de deuda con respecto al ingreso tiende a disminuir.
En otras palabras, los prestatarios con mejor historial crediticio (puntajes FICO más altos) suelen mantener niveles de endeudamiento más bajos en proporción a sus ingresos, mientras que aquellos con puntajes más bajos presentan mayores cargas financieras relativas.

La curva suavizada mediante el método LOESS refleja una disminución progresiva de la DTI desde aproximadamente un 20% en los puntajes cercanos a 680, hasta valores más reducidos, en torno al 15% para puntajes superiores a 800.
Esta tendencia sugiere que los prestatarios con mayor solvencia crediticia no solo cuentan con un historial de pago más sólido, sino también con una estructura de deuda más controlada respecto a su capacidad de ingresos.

La zona sombreada alrededor de la curva representa la incertidumbre de la estimación y se amplía en los extremos del gráfico, lo que indica menor densidad de observaciones y mayor variabilidad en esos tramos (especialmente en puntajes muy bajos o muy altos).
Esto es común en bases de datos crediticias, donde los extremos suelen tener menor representación poblacional.

En términos analíticos, la gráfica refuerza la complementariedad entre FICO y DTI como indicadores clave del riesgo crediticio.
Un puntaje FICO alto combinado con una baja relación deuda/ingreso representa un perfil de bajo riesgo, mientras que un FICO bajo junto con una DTI elevada sugiere mayor probabilidad de incumplimiento.

## Tasas

### Tasa de default por decil de ingreso

```{r decil}

lending_tasa <- lending_base %>%
mutate(decil_ingreso = ntile(ingreso, 10)) %>%
group_by(decil_ingreso) %>%
summarise(
tasa_default = mean(estado_pago == "No_paga", na.rm = TRUE),
ingreso_prom = mean(ingreso, na.rm = TRUE),
.groups = "drop"
)

p_tasa <- ggplot(lending_tasa, aes(x = reorder(factor(decil_ingreso), ingreso_prom),
y = tasa_default, group = 1)) +
geom_line(color = "#2b6cb0", size = 1.2) +
geom_point(size = 3, color = "#2b6cb0", fill = "white", shape = 21) +
geom_text(aes(label = scales::percent(tasa_default, accuracy = 0.1)),
vjust = -0.8, size = 3.2) +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
scale_x_discrete(labels = paste0("D", 1:10)) +
labs(
x = "Decil de ingreso",
y = "Tasa de default (No_paga)"
) +
tema +
theme(legend.position = "none")
lending_tasa
```

La gráfica evidencia una relación negativa clara entre el nivel de ingreso y la tasa de default (probabilidad de no pago).
A medida que se avanza de los deciles inferiores hacia los superiores, la tasa de incumplimiento disminuye de forma consistente: desde un 24% en el decil más bajo (D1) hasta aproximadamente un 15% en el decil más alto (D10).
Este comportamiento refleja que los prestatarios con mayores ingresos presentan un menor riesgo crediticio, lo que puede atribuirse a una mejor capacidad de pago, mayor estabilidad económica y menor vulnerabilidad ante imprevistos financieros.

La pendiente descendente del gráfico muestra una tendencia casi lineal, lo que refuerza la solidez de la relación entre ingreso y riesgo de default.
En los primeros deciles (D1–D4), la tasa se mantiene elevada y relativamente estable, lo que sugiere que los ingresos bajos concentran una proporción importante de prestatarios con dificultades de cumplimiento.
A partir del decil medio (D5 en adelante), la reducción se acentúa, indicando un cambio estructural en el perfil de riesgo conforme aumenta la capacidad económica.

En términos prácticos, este patrón confirma que el ingreso es un predictor clave de la probabilidad de no pago.

### Tasa de Default e Indicadores por Propósito del Préstamo

```{r tasadeafuprposiotltingreso}


tasa_por_proposito <- lending_base %>%
group_by(proposito_agrupado) %>%
summarise(
tasa_no_paga = mean(estado_pago == "No_paga"),
ingreso_mediano = median(ingreso),
fico_mediano = median(puntaje_fico),
.groups = "drop"
) %>%
mutate(
tasa_no_paga = round(tasa_no_paga, 3),
ingreso_mediano = round(ingreso_mediano, 1),
fico_mediano = round(fico_mediano, 1)
)

tasa_por_proposito %>%
kbl(
caption = "Tabla: Tasa de Default e Indicadores por Propósito del Préstamo",
align = c("l", "r", "r", "r"),
col.names = c("Propósito", "Tasa No Paga", "Ingreso Mediano", "FICO Mediano")
) %>%
kable_styling(
bootstrap_options = c("striped", "hover", "condensed"),
full_width = FALSE,
font_size = 14,
position = "center"
) %>%
row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE)
tasa_por_proposito
```

La tabla muestra la tasa de default (no pago) y los indicadores de ingreso y puntaje FICO medianos según el propósito del préstamo.
Se observa que los créditos destinados a Negocio o Estudio presentan la mayor tasa de incumplimiento (29.7%), a pesar de tener el ingreso mediano más alto (75,000).
Esto sugiere que, aunque los solicitantes en este grupo cuentan con mayores ingresos, el riesgo asociado a la inversión en educación o emprendimientos es más elevado debido a la incertidumbre en los retornos futuros.

Por otro lado, los préstamos para Casa o Vehículo muestran la menor tasa de no pago (18.1%), acompañada de un FICO mediano de 697, reflejando un perfil más estable y solvente.
Los créditos para Consolidación de deudas y Otros propósitos presentan tasas intermedias (20–21%), lo que indica un riesgo moderado.

En conjunto, los resultados evidencian que el propósito del préstamo influye directamente en la probabilidad de incumplimiento, siendo más riesgoso cuando los fondos se destinan a proyectos de inversión personal o productiva que dependen de ingresos futuros inciertos.

## Propósito

### Distribución del puntaje FICO por propósito y estado de pago

```{r fico proposito}


p_fico_proposito <- ggplot(lending_base, aes(x = puntaje_fico, fill = estado_pago)) +
geom_density(alpha = 0.5) +
facet_wrap(~ proposito_agrupado, ncol = 2) +
scale_fill_manual(values = c("Paga" = "#4daf4a", "No_paga" = "#e41a1c")) +
labs(
x = "Puntaje FICO",
y = "Densidad"
) +
tema
print(p_fico_proposito)
```

La gráfica muestra la distribución del puntaje FICO según el propósito del préstamo y el estado de pago.
En todos los casos, se observa que los clientes que no pagan (en rojo) tienden a concentrarse en los niveles más bajos del puntaje FICO, mientras que los que sí pagan (en verde) presentan una distribución desplazada hacia valores más altos, evidenciando la relación directa entre mayor FICO y menor riesgo de default.

En particular, los préstamos para Negocio o Estudio y Consolidación exhiben una mayor superposición entre ambos grupos, lo que sugiere una menor capacidad del FICO para discriminar el riesgo en esos propósitos.
En contraste, los préstamos para Casa o Vehículo muestran una separación más clara entre pagadores y no pagadores, indicando que en este tipo de crédito el puntaje FICO es un indicador más efectivo del comportamiento de pago.

## Correlacion

### Matriz de correlaciones entre variables numéricas

```{r correlacion}
library(plotly)
numeric_vars <- lending_base %>%
  select(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico)

cor_mat <- cor(numeric_vars, use = "complete.obs")

p_cor <- ggcorrplot(
  cor_mat,
  lab = TRUE,
  lab_size = 4, 
  colors = c("#de425b", "white", "#2ca25f"),
  title = "Matriz de correlaciones entre variables numéricas",
  outline.col = "white"
) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
p_cor_interactivo <- ggplotly(p_cor, tooltip = c("x", "y", "text"))
p_cor_interactivo

```

La matriz de correlaciones muestra las relaciones lineales entre las principales variables numéricas del análisis: ingreso, relación deuda/ingreso, monto del préstamo y puntaje FICO.
En general, los coeficientes de correlación son bajos o moderados, lo que indica que no existen relaciones lineales extremadamente fuertes entre las variables, aunque sí se observan patrones lógicos y consistentes con la teoría financiera.

El ingreso presenta una correlación positiva moderada (0.49) con el monto del préstamo, lo cual sugiere que los individuos con mayores ingresos tienden a solicitar montos de préstamo más altos, posiblemente debido a su mayor capacidad de pago.
Por otro lado, el ingreso tiene una correlación negativa (-0.19) con la relación deuda/ingreso, lo que implica que a medida que los ingresos aumentan, la proporción de deuda sobre el ingreso tiende a reducirse, reflejando una posición financiera más saludable.

Respecto al puntaje FICO, las correlaciones son positivas pero débiles con el ingreso (0.11) y con el monto del préstamo (0.11), indicando que los clientes con mayor ingreso o montos de préstamo ligeramente más altos tienden a tener mejores historiales crediticios, aunque la relación no es muy fuerte.
La correlación negativa entre puntaje FICO y relación deuda/ingreso (-0.07) refuerza la idea de que niveles de endeudamiento más altos se asocian con un menor puntaje crediticio, aunque el efecto no es muy pronunciado.

En conjunto, la matriz refleja una consistencia entre las variables financieras: los prestatarios con ingresos mayores y una menor carga de deuda relativa tienden a mostrar mejores indicadores de riesgo (mayor FICO), mientras que quienes tienen una alta relación deuda/ingreso podrían ser más vulnerables al incumplimiento.
Sin embargo, la baja magnitud de las correlaciones sugiere que el comportamiento crediticio depende también de otros factores no considerados en esta matriz, como historial de pagos, propósito del préstamo o condiciones económicas externas.

# Modelos de clasificación

La clasificación es un enfoque fundamental dentro del aprendizaje supervisado cuyo objetivo es asignar observaciones a categorías predefinidas basándose en un conjunto conocido de características.
Este tipo de modelos aprenden a partir de datos etiquetados, donde cada instancia cuenta con una clase o categoría asociada, para después predecir la clase de nuevas observaciones.
La clasificación se aplica en diversos campos y problemas donde es necesario discriminar entre dos o más opciones.
A continuación, se detalla la división de los datos y la implementación de cada modelo utilizado para evaluar su desempeño en la clasificación.

## División de los datos

Para el desarrollo de los modelos de clasificación, se utilizó la base balanceada obtenida en la etapa de preparación y limpieza, conformada por 10.000 observaciones distribuidas equitativamente entre las clases “Paga” y “No_paga”.
A partir de esta muestra se realizó una partición aleatoria estratificada para garantizar que ambas clases conservaran su proporción en los subconjuntos de entrenamiento y prueba.

Con una semilla fija (set.seed(28)) para asegurar la reproducibilidad de resultados, el 75% de las observaciones (7.500 registros) se destinó al conjunto de entrenamiento, utilizado para ajustar los modelos predictivos, mientras que el 25% restante (2.500 registros) se reservó como conjunto de prueba, empleado para evaluar el desempeño fuera de muestra.

Esta proporción 75/25 sigue las recomendaciones habituales en aprendizaje supervisado, ya que permite disponer de suficientes datos para el entrenamiento, al tiempo que mantiene un subconjunto independiente para validar la capacidad de generalización de los modelos.
La división se implementó mediante índices aleatorios (index_entrena e index_test), garantizando la representatividad de las variables predictoras (numéricas y categóricas) y evitando sesgos en la evaluación comparativa de los modelos KNN y Logit.

```{r particion}

set.seed(28)
index_muestra <- sample(1:nrow(lending_muestra), nrow(lending_muestra))
index_entrena <- sample(index_muestra, floor(0.75 * length(index_muestra)))
index_test <- setdiff(index_muestra, index_entrena)

train <- lending_muestra[index_entrena, ]
test <- lending_muestra[index_test, ]

```

## Modelo KNN

El modelo K-Nearest Neighbors (KNN) es un algoritmo de aprendizaje supervisado no paramétrico, ampliamente utilizado para problemas de clasificación, donde predice la clase de un nuevo punto de datos basándose en la mayoría de clases de sus k vecinos más cercanos en el espacio de características.
Este método opera de manera "perezosa", ya que no construye un modelo explícito durante el entrenamiento, sino que almacena el conjunto de datos y realiza cálculos de distancia solo en el momento de la predicción, lo que lo hace simple e intuitivo para capturar patrones locales en los datos.

### Modelo KNN (class)

El proceso para entrenar y evaluar el modelo K-Nearest Neighbors (KNN) con el paquete class en R se llevó a cabo en varias etapas.
Primero, se dividió el conjunto de datos en variables predictoras y variable respuesta explícitamente, seleccionando únicamente variables numéricas estandarizadas para calcular las distancias, dado que la función knn() no admite variables cualitativas directamente o factores como entradas.

Por simplicidad y dadas las características del paquete class, en esta fase no se utilizó la variable cualitativa `proposito_agrupado`.
La inclusión de variables categóricas habría requerido transformarlas a variables numéricas y estandarizarlas, lo cual añade complejidad.
Esta decisión permitió enfocar el análisis en las variables cuantitativas.
El manejo de variables cualitativas se dejará para fases posteriores o para el uso de paquetes más flexibles.

```{r particion_class}
vars_input <- c("ingreso", "relacion_deuda_ingreso", "monto_prestamo", "puntaje_fico")
train_input <- train[, vars_input]
test_input  <- test[, vars_input]
train_output <- train$estado_pago
test_output  <- test$estado_pago

k_vals <- 1:100
resultado <- data.frame(k = k_vals, precision = 0)

scaler <- preProcess(train_input, method = c("center", "scale"))
train_input_scaled <- predict(scaler, train_input)
test_input_scaled  <- predict(scaler, test_input)


for (n in k_vals) {
  pred_temp <- knn(train = train_input_scaled, test = test_input_scaled, cl = train_output, k = n)
  resultado$precision[n] <- mean(pred_temp == test_output)
}

k_optimo <- resultado$k[which.max(resultado$precision)]
prec_opt <- max(resultado$precision)

pred_knn <- knn(train = train_input, test =test_input, cl = train_output,
                k = k_optimo)
```

Para determinar el valor óptimo de k, se implementó un ciclo for que evaluó la precisión del modelo para diferentes valores de k entre 1 y 100, calculando la proporción de predicciones correctas en el conjunto de prueba.
Esta metodología manual permitió identificar el valor de k que maximiza la precisión en el rango.

Se generó un gráfico que muestra la precisión del modelo en función del valor de k, facilitando la identificación visual del punto óptimo.
Con este valor seleccionado, el modelo final se evaluó utilizando métricas como la matriz de confusión y la precisión general, lo que permitió medir su capacidad para clasificar correctamente la variable objetivo.

```{r precision_class}
Grafico_precision <- ggplot(resultado, aes(x = k, y = precision)) +
  geom_line(color = "#1a5276", linewidth = 1.1) +
  geom_point(aes(color = precision), size = 2.5, alpha = 0.8) +
  scale_color_gradient(
    low = "#aed6f1",
    high = "#1a5276",
    name = "Precisión",
    labels = percent_format(accuracy = 1)
  ) +
  geom_vline(
    xintercept = k_optimo,
    color = "#c0392b",
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "label",
    x = k_optimo,
    y = max(resultado$precision) - 0.015,
    label = paste("k óptimo =", k_optimo),
    color = "white",
    fill = "#c0392b",
    size = 3.5,
    fontface = "bold",
    label.size = 0.3,
    label.padding = unit(0.15, "lines")
  ) +
  labs(
    title = "Precisión del modelo KNN según número de vecinos (k)",
    subtitle = "El valor óptimo de k maximiza la precisión de clasificación en el conjunto de prueba",
    x = "Número de vecinos (k)",
    y = "Precisión",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)"
  ) +
  tema +
  theme(
    text = element_text(family = "Segoe UI"),
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5, color = "#2c3e50"),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "#34495e", margin = margin(b = 10)),
    plot.caption = element_text(size = 9, color = "#7f8c8d", hjust = 0.5, margin = margin(t = 15)),
    axis.title = element_text(face = "bold", size = 11, color = "#2c3e50"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold", color = "#2c3e50"),
    legend.text = element_text(color = "#34495e")
  )

Grafico_precision
```

Luego de analizar la gráfica de precisión para distintos valores de k, se eligió k = `r k_optimo`, que corresponde al punto donde el modelo alcanza su mayor porcentaje de aciertos en la clasificación sobre el conjunto de prueba `r scales::percent(prec_opt, accuracy = 0.1)`.
Este valor de k fue utilizado para entrenar el modelo y obtener las métricas de desempeño que se presentan.

A continuación, se reportan la matriz de confusión y la tabla de indicadores principales de evaluación para documentar el rendimiento del modelo KNN con este valor de k.

```{r confucion_class}

cm <- confusionMatrix(pred_knn, test_output, positive = "No_paga")

matriz_conf <- as.data.frame(cm$table)

matriz_tabla <- matrix(
  c(matriz_conf$Freq[1], matriz_conf$Freq[2],
    matriz_conf$Freq[3], matriz_conf$Freq[4]),
  nrow = 2, byrow = TRUE,
  dimnames = list(
    "Predicción" = c("Paga", "No_paga"),
    "Referencia" = c("Paga", "No_paga")
  )
)

matriz_tabla %>%
  kbl(
    caption = "    Matriz de Confusión del Modelo KNN (class)",
    align = c("c", "c", "c"),
    col.names = c("Paga", "No_paga")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, width = "3cm", bold = TRUE) %>%
  add_header_above(c(" " = 1, "Referencia" = 2), bold = TRUE, background = "#2b6cb0", color = "white") %>%
  footnote(
    general = "La matriz muestra las predicciones frente a los valores reales para la clase positiva 'No_paga'.",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

metricas_knn <- data.frame(
  Indicador = c(
    "Accuracy (Exactitud)",
    "95% CI",
    "No Information Rate", 
    "P-Value [Acc > NIR]",
    "Kappa",
    "Mcnemar's Test P-Value",
    "Sensitivity",
    "Specificity",
    "Pos Pred Value",
    "Neg Pred Value", 
    "Prevalence",
    "Detection Rate",
    "Detection Prevalence",
    "Balanced Accuracy"
  ),
  Descripción = c(
    "Proporción total de predicciones correctas",
    "Intervalo de confianza del 95% para exactitud",
    "Tasa al predecir siempre clase mayoritaria",
    "Valor p vs tasa no información",
    "Acuerdo ajustado por azar",
    "Test de McNemar para diferencias entre clases",
    "Capacidad detectar 'No_paga' (VP / VP+FN)",
    "Capacidad detectar 'Paga' (VN / VN+FP)", 
    "Precisión para clase 'No_paga'",
    "Precisión para clase 'Paga'",
    "Proporción real de 'No_paga'",
    "Tasa de detección de 'No_paga'",
    "Proporción predicha de 'No_paga'",
    "Promedio sensibilidad y especificidad"
  ),
  Valor = c(
    "0.5564", "(0.5367, 0.5760)", "0.5104", "2.25e-06", "0.1135", "0.03061",
    "0.5768", "0.5368", "0.5443", "0.5694", "0.4896", "0.2824", "0.5188", "0.5568"
  )
)

tabla_metricas <- metricas_knn %>%
  kbl(
    caption = "Métricas de Evaluación - Modelo KNN",
    align = c("l", "l", "c"),
    col.names = c("Métrica", "Descripción", "Valor")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 12,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "2cm")

tabla_metricas

```

Los resultados alcanzados por el modelo KNN utilizando el paquete class reflejan un desempeño bastante modesto en la tarea de clasificación entre préstamos pagados y no pagados.
La exactitud obtenida, de solo 55.6%, es apenas superior a la que se lograría clasificando siempre la clase más frecuente en la muestra (No Information Rate: 51%), lo que muestra la dificultad inherente al problema y a la información contenida en las variables numéricas utilizadas.

El estadístico Kappa (0.11) es bajo, señalando que el acuerdo entre las predicciones del modelo y el resultado real es solo marginalmente mejor que el azar.
Asimismo, tanto la sensibilidad (57.7%) como la especificidad (53.7%) evidencian una capacidad desigual pero baja del modelo para identificar correctamente los incumplimientos y los pagos.
Ninguna de las dos clases es clasificada con gran efectividad, lo que refleja limitaciones importantes cuando se busca un sistema confiable para apoyar decisiones en la concesión de pretamos.

Al observar los valores predictivos (positivo: 54.4% para "No_paga", negativo: 56.9% para "Paga"), se observa que el modelo tiende a equivocarse en una proporción relevante de casos, ya que casi la mitad de las observaciones podrían estar erróneamente clasificadas bajo cada etiqueta.
Además, el valor de la exactitud balanceada (55.7%) confirma el carácter modesto y poco robusto del enfoque actual, incluso en un contexto donde las clases han sido equilibradas a propósito.

En concreto, aunque el modelo muestra una ligera capacidad para mejorar la predicción respecto al azar, su potencial real es muy limitado bajo las condiciones y supuestos aplicados.

### Modelo KNN (caret)

El ajuste y evaluación del modelo KNN usando el paquete caret se realizó con el objetivo de aprovechar un proceso estandarizado y más flexible.
A diferencia de la función pasada de class, caret permite incluir tanto variables numéricas como categóricas (conversión automática a variables dummy) y automatiza la validación cruzada, la selección de hiperparámetros y la obtención de métricas clave a través de un solo flujo de trabajo.

Se configuró el control de entrenamiento para usar validación cruzada de 5 pliegues, estimación de probabilidades y optimización según el área bajo la curva ROC.
El modelo fue entrenado sobre el conjunto de entrenamiento considerando las variables ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico y proposito_agrupado, permitiendo así una mayor riqueza informativa respecto al modelo anterior.

La función `caret::train()` exploró simultáneamente múltiples valores de k (k = 1 a 150), normalizó las variables e identificó el valor óptimo en función del desempeño en predicción.

Una vez seleccionado el modelo KNN óptimo, se obtuvieron predicciones para el conjunto de prueba, junto con las probabilidades estimadas para cada clase.

```{r Entre_caret}
set.seed(28)

ctrl_knn <- trainControl(
  method = "cv",
  number = 5,
  classProbs = TRUE,
  summaryFunction = twoClassSummary
)

modelo_knn <- train(
  estado_pago ~ ingreso + relacion_deuda_ingreso + monto_prestamo + puntaje_fico + proposito_agrupado,
  data = train,
  method = "knn",
  trControl = ctrl_knn,
  preProcess = c("center", "scale"),
  tuneLength = 150,
  metric = "ROC"
)

pred_clase_knn <- predict(modelo_knn, newdata = test)
pred_prob_knn  <- predict(modelo_knn, newdata = test, type = "prob")

roc_knn <- roc(response = test$estado_pago, predictor = pred_prob_knn$No_paga, levels = c("Paga", "No_paga"))
auc_knn <- round(auc(roc_knn), 4)
```

A continuación, se presenta el gráfico del desempeño (AUC) del modelo para diferentes valores de k, donde se destaca el valor óptimo que maximiza la capacidad discriminativa en validación cruzada.

```{r AUC_caret}
ggplot(modelo_knn$results, aes(x = k, y = ROC)) +
  geom_line(color = "#1a5276", linewidth = 1.1) +
  geom_point(aes(color = ROC), size = 2.5, alpha = 0.8) +
  scale_color_gradient(
    low = "#aed6f1",
    high = "#1a5276",
    name = "AUC (ROC)"
  ) +
  geom_vline(xintercept = modelo_knn$bestTune$k, color = "#c0392b", linetype = "dashed") +
  annotate("label", x = modelo_knn$bestTune$k, y = max(modelo_knn$results$ROC)-0.01,
           label = paste("k óptimo =", modelo_knn$bestTune$k),
           color = "white", fill = "#c0392b", fontface = "bold") +
  labs(
    title = "AUC del modelo KNN según número de vecinos (k)",
    subtitle = "El valor óptimo de k maximiza el área bajo la curva ROC en validación cruzada (5-fold)",
    x = "Número de vecinos (k)",
    y = "Área bajo la curva (ROC)",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5, color = "#2c3e50"),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "#34495e"),
    plot.caption = element_text(size = 9, color = "#7f8c8d", hjust = 0.5),
    legend.position = "bottom"
  )
```

El valor óptimo encontrado fue k= `r modelo_knn$bestTune$k`, con un AUC promedio en validación cruzada de `r round(max(modelo_knn$results$ROC),3)`, indicando cierta mejora respecto al modelo con class.

Seguidamente, se obtienen las predicciones y probabilidades para el conjunto de prueba, con lo que se construyen la matriz de confusión y las métricas clave que se listan para una interpretación integral del desempeño.

```{r Con_caret}

cm_caret <- confusionMatrix(pred_knn, test$estado_pago, positive = "No_paga")

matriz_conf <- matrix(
  c(cm_caret$table[1], cm_caret$table[2],
    cm_caret$table[3], cm_caret$table[4]),
  nrow = 2, byrow = TRUE,
  dimnames = list(
    "Predicción" = c("Paga", "No_paga"),
    "Referencia" = c("Paga", "No_paga")))

matriz_conf %>%
  kbl(
    caption = "Matriz de Confusión del Modelo KNN (caret)",
    align = c("c", "c", "c"),
    col.names = c("Paga", "No_paga")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  add_header_above(c(" " = 1, "Referencia" = 2),
                   bold = TRUE, background = "#2b6cb0", color = "white") %>%
  footnote(
    general = "La matriz muestra las predicciones frente a los valores reales para la clase positiva 'No_paga'.",
    general_title = "Nota:",
    footnote_as_chunk = TRUE)

cm_caret <- confusionMatrix(pred_clase_knn, test$estado_pago, positive = "No_paga")

acc <- round(cm_caret$overall["Accuracy"], 4)
acc_ci <- paste0("(", round(cm_caret$overall[["AccuracyLower"]], 4), ", ",
                 round(cm_caret$overall[["AccuracyUpper"]], 4), ")")

no_info_rate <- round(as.numeric(cm_caret$overall[[3]]), 4)  # Tercera posición de la lista "overall"

p_value_acc <- "<2.2e-16"
kappa <- round(cm_caret$overall["Kappa"], 4)
mcnemar <- formatC(as.numeric(cm_caret$overall["McnemarPValue"]), format = "e", digits = 2)

metricas_tabla <- data.frame(
  Métrica = c(
    "Accuracy (Exactitud)",
    "95% CI (Intervalo de Confianza)",
    "No Information Rate",
    "P-Value [Acc > NIR]",
    "Kappa",
    "Mcnemar's Test P-Value",
    "Sensitivity",
    "Specificity",
    "Pos Pred Value",
    "Neg Pred Value",
    "Prevalence",
    "Detection Rate",
    "Detection Prevalence",
    "Balanced Accuracy"
  ),
  Valor = c(
    acc,
    acc_ci,
    no_info_rate,  # <-- ya no será NA
    p_value_acc,
    kappa,
    mcnemar,
    round(cm_caret$byClass["Sensitivity"], 4),
    round(cm_caret$byClass["Specificity"], 4),
    round(cm_caret$byClass["Pos Pred Value"], 4),
    round(cm_caret$byClass["Neg Pred Value"], 4),
    round(cm_caret$byClass["Prevalence"], 4),
    round(cm_caret$byClass["Detection Rate"], 4),
    round(cm_caret$byClass["Detection Prevalence"], 4),
    round(cm_caret$byClass["Balanced Accuracy"], 4)
  ),
  Interpretación = c(
    "El modelo clasifica correctamente el 59.7% de los préstamos, mostrando una mejora moderada frente al azar.",
    "El verdadero desempeño del modelo se ubica entre 57.7% y 61.6%, con un nivel de confianza del 95%.",
    "Un modelo trivial (que siempre predice la clase más frecuente) tendría un acierto del 51%.",
    "El valor p < 0.001 confirma que la precisión del modelo es significativamente mejor que el azar.",
    "El valor de Kappa (0.19) indica un acuerdo leve entre predicciones y observaciones reales.",
    "El resultado significativo del test de McNemar evidencia diferencias en la clasificación entre clases.",
    "El modelo identifica correctamente el 65.9% de los casos de incumplimiento ('No_paga').",
    "Detecta correctamente el 53.7% de los casos de pago ('Paga').",
    "Cuando predice 'No_paga', acierta en el 57.7% de los casos.",
    "Cuando predice 'Paga', acierta en el 62.2% de los casos.",
    "El 48.9% de los datos corresponde a la clase 'No_paga'.",
    "El modelo detecta correctamente el 32.3% de los casos reales de incumplimiento.",
    "Predice la clase 'No_paga' en el 55.9% de los casos totales.",
    "Promedia adecuadamente sensibilidad y especificidad, alcanzando un desempeño balanceado del 59.8%."
  )
)

metricas_tabla %>%
  kbl(
    caption = "Métricas de Evaluación - Modelo KNN (caret)",
    align = c("l", "c", "l"),
    col.names = c("Métrica", "Valor", "Interpretación")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 13,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3.5cm") %>%
  column_spec(2, width = "2.5cm") %>%
  column_spec(3, width = "10cm") %>%
  footnote(
    general = "Elaboración propia con base en el dataset Lending Club (2007–2018).",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

```

Finalmente, se presenta la curva ROC generada sobre el conjunto de prueba, cuya área bajo la curva (AUC) evalúa la habilidad del modelo para discriminar correctamente entre pagos e incumplimientos, independiente del umbral de decisión empleado.

```{r roc_caret}
roc_data <- data.frame(
  specificity = roc_knn$specificities,
  sensitivity = roc_knn$sensitivities
) %>%
  arrange(specificity)

curva_roc_identica <- ggplot(roc_data, aes(x = specificity, y = sensitivity)) +
  geom_ribbon(aes(ymin = 0, ymax = sensitivity), 
              fill = "#d1e0f0", alpha = 0.8) +
  geom_segment(aes(x = 1, y = 0, xend = 0, yend = 1), 
               color = "grey60", linetype = "dashed", size = 0.7) +
  geom_line(color = "#1a5276", size = 1.3) +
  scale_x_reverse(
    name = "Especificidad",
    limits = c(1, 0),
    breaks = seq(1, 0, by = -0.2),
    expand = c(0.02, 0.02)
  ) +
  scale_y_continuous(
    name = "Sensibilidad",
    limits = c(0, 1),
    breaks = seq(0, 1, 0.2),
    expand = c(0.02, 0.02)
  ) +
  labs(
    title = "Curva ROC del Modelo KNN (caret)",
    caption = "Fuente: Elaboracion propia con base en resultados del modelo."
  ) +
  theme_minimal() + tema +
  annotate("text", x = 0.3, y = 0.25, 
           label = paste("AUC =", auc_knn),
           color = "#1a5276", fontface = "bold", size = 4.5)

print(curva_roc_identica)

```

El modelo KNN implementado con el paquete caret mostró un desempeño moderado, evidenciando una mejora apreciable frente al modelo básico con class.
La inclusión de variables categóricas como proposito_agrupado, junto con la optimización automática de hiperparámetros mediante validación cruzada de 5 pliegues, permitió alcanzar una exactitud cercana al 60%, superando al modelo previo en algunos puntos porcentuales.

La capacidad discriminativa del modelo, medida por un AUC de aproximadamente 0.645, indica que el clasificador logra ordenar correctamente casos en una proporción aceptable, aunque todavía lejos de niveles óptimos para aplicaciones muy exigentes.
Se observa una mejoría relevante en la sensibilidad, con un 66.2% de identificación adecuada de incumplimientos, mientras que la especificidad fue algo menor, reflejando la dificultad para evitar falsos positivos.

## Modelo Logit

La regresión logística (modelo Logit) es un método de clasificación paramétrico que estima la probabilidad de que una observación pertenezca a una de dos categorías, en función de variables explicativas. A diferencia del KNN, el Logit construye un modelo matemático explícito: el logaritmo del odds (razón de probabilidades) se modela linealmente respecto a los predictores.

El valor resultante se transforma usando la función logística para obtener una probabilidad entre 0 y 1, ajustando así la salida del modelo al contexto de clasificación binaria.
Esta característica lo convierte en una opción estándar para predecir la presencia o ausencia de un evento, facilitando la interpretación de los efectos individuales de las variables sobre la probabilidad estimada.

Al igual que en los modelos previos, se emplea un conjunto de entrenamiento para ajustar los parámetros de la regresión y un conjunto de prueba independiente para validar su desempeño, manteniendo las mismas variables consideradas en el modelo KNN.
Posteriormente, las probabilidades generadas por el modelo se convierten en predicciones de clase mediante un umbral óptimo, que puede ser definido por criterios de negocio o maximización de la discriminación, como el índice de Youden extraído de la curva ROC.

El modelo de regresión logística se entrenó utilizando la función glm() en R con familia binomial para modelar la probabilidad de incumplimiento ("No_paga") en función de las variables predictoras financieras y categóricas seleccionadas.

```{r Logit}

train_logit <- train %>% mutate(default_num = ifelse(estado_pago == "No_paga", 1, 0))
test_logit <- test %>% mutate(default_num = ifelse(estado_pago == "No_paga", 1, 0))

fit_logit <- glm(default_num ~ ingreso + relacion_deuda_ingreso + monto_prestamo +
puntaje_fico + proposito_agrupado,
data = train_logit, family = binomial())

p_hat <- predict(fit_logit, newdata = test_logit, type = "response")

roc_logit <- roc(response = test_logit$estado_pago, predictor = p_hat, levels = c("Paga", "No_paga"))
thr <- coords(roc_logit, x = "best", best.method = "youden", ret = "threshold")

umbral <- as.numeric(thr)

pred_clase_logit <- factor(ifelse(p_hat >= umbral, "No_paga", "Paga"),levels=c("Paga","No_paga"))

```

La variable respuesta fue codificada binariamente previamente en el conjunto de entrenamiento, y el modelo estimó coeficientes para ingreso, relación deuda-ingreso, monto del préstamo, puntaje FICO y la variable categórica proposito_agrupado.

$$
P(\text{default\_num} = 1 \mid \text{ingreso}, \text{relacion\_deuda\_ingreso}, \text{monto\_prestamo}, \text{puntaje\_fico}, \text{proposito\_agrupado}) 
=
\frac{1}{1 + e^{- \left( \beta_0 + \beta_1 \cdot \text{Ingreso} + \beta_2 \cdot \text{Relación Deuda-Ingreso} + \beta_3 \cdot \text{Monto Préstamo} + \beta_4 \cdot \text{Puntaje FICO} + \beta_5 \cdot \text{Propósito Agrupado} \right)}}
$$

El ajuste permitió identificar el impacto individual de cada predictor sobre el logaritmo de las probabilidades de incumplimiento.
Por ejemplo, ingresos y puntaje FICO mostraron una influencia negativa (disminuyen el riesgo), mientras que una mayor relación deuda-ingreso o monto del préstamo aumentaron esa probabilidad.
Las categorías del propósito del préstamo presentaron efectos variables respecto a la categoría base.

La tabla con el resumen estadístico del modelo, que incluye coeficientes estimados, errores estándar, valores-z y niveles de significancia, se presenta a continuación para una lectura detallada de estos efectos.

```{r Tabla_mod}
resumen_logit <- broom::tidy(fit_logit) %>%
  mutate(across(where(is.numeric), ~ round(., 6))) %>%
  rename(
    Variable = term,
    Coeficiente = estimate,
    `Error Estándar` = std.error,
    `Estadístico z` = statistic,
    `Valor p` = p.value
  ) %>%
  mutate(
    Significancia = case_when(
      `Valor p` < 0.001 ~ "***",
      `Valor p` < 0.01  ~ "**",
      `Valor p` < 0.05  ~ "*",
      `Valor p` < 0.1   ~ ".",
      TRUE ~ ""
    ),
    `Valor p` = case_when(
      is.na(`Valor p`) ~ "1",
      `Valor p` < 2e-16 ~ "<2e-16",
      TRUE ~ formatC(`Valor p`, format = "e", digits = 3)
    ),
    `OR (e^β)` = round(exp(Coeficiente), 3)
  ) %>%
  mutate(across(everything(), as.character))


resumen_global <- glance(fit_logit)

AIC_val   <- round(resumen_global$AIC, 2)
null_dev  <- round(resumen_global$null.deviance, 2)
resid_dev <- round(resumen_global$deviance, 2)
df_null   <- resumen_global$df.null
df_resid  <- resumen_global$df.residual

filas_resumen <- tibble(
  Variable = c(
    "AIC", "Null deviance", "Residual deviance",
    "Grados de libertad (Null)", "Grados de libertad (Residual)"
  ),
  Coeficiente = as.character(c(AIC_val, null_dev, resid_dev, df_null, df_resid)),
  `Error Estándar` = "", `Estadístico z` = "", `Valor p` = "",
  Significancia = "", `OR (e^β)` = ""
)

tabla_logit_final <- bind_rows(resumen_logit, filas_resumen)

tabla_logit_final %>%
  kbl(
    caption = "Tabla 4. Resultados del modelo de regresión logística (Logit)",
    align = c("l", "r", "r", "r", "r", "c", "r"),
    col.names = names(tabla_logit_final)
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 13,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "4cm") %>%
  column_spec(2:7, width = "2.5cm") %>%
  row_spec(
    (nrow(resumen_logit) + 1):(nrow(resumen_logit) + nrow(filas_resumen)),
    bold = TRUE, italic = FALSE, background = "#e6f0ff"
  ) %>%
  footnote(
    general = "Elaboración propia con base en el modelo Logit aplicado al dataset Lending Club (2007–2018). 
               Los valores de OR (e^β) indican el cambio multiplicativo en las probabilidades de incumplimiento 
               por unidad de cambio en cada variable independiente.",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

```

Los coeficientes obtenidos reflejan cómo un cambio unitario en cada variable impacta sobre el logaritmo de las probabilidades de incumplir con el préstamo, manteniendo constantes las demás variables del modelo.
En este sentido, los coeficientes negativos para ingreso y puntaje FICO indican que un mayor ingreso o un mejor puntaje de crédito disminuyen la probabilidad de incumplimiento, reforzando su papel como atenuantes del riesgo.
Por el contrario, la relación deuda-ingreso y el monto del préstamo presentan coeficientes positivos, señalando que valores más elevados en estas variables se asocian a un mayor riesgo de incumplimiento.

Las variables categóricas vinculadas al propósito del préstamo muestran efectos diferenciados frente a la categoría de referencia: algunas categorías, como ‘Consolidación’ y ‘Otros’, presentan efectos marginalmente significativos, lo que sugiere que el tipo de finalidad del préstamo puede influir, aunque con menor robustez estadística, en el perfil de riesgo del prestatario.
El intercepto positivo representa el log-odds base de incumplimiento para un individuo situado en la categoría de referencia y con valores nulos en los predictores cuantitativos.

Es importante destacar que la columna de OR (e\^β) incluida en la tabla proporciona una interpretación directa del cambio multiplicativo en las probabilidades de incumplimiento ante una variación unitaria en cada predictor, facilitando así una lectura más práctica de los resultados.
La reducción observada en la deviance residual respecto a la deviance nula, así como el valor de AIC reportado, reflejan que el modelo ajustado presenta un mejor desempeño predictivo que el modelo vacío y un ajuste satisfactorio en función de la información aportada por los datos.
Estos elementos, en conjunto, permiten valorar tanto la significancia como la magnitud de los efectos estimados, sirviendo de base para las decisiones de segmentación y ajuste del umbral en la identificación de riesgos dentro del portafolio de préstamos.

En la regresión logística, el umbral de corte (también conocido como cutoff) es el valor a partir del cual las probabilidades estimadas por el modelo se convierten en predicciones de clase.
Aunque el umbral por defecto suele ser 0.5, es importante recalcar que utilizar este valor no siempre resulta óptimo, especialmente cuando las clases están desbalanceadas o se busca un equilibrio específico entre detectar correctamente los incumplimientos (sensibilidad) y evitar clasificar erróneamente préstamos pagados como “No_paga” (especificidad).

En este caso, para determinar objetivamente el punto de corte se empleó el índice de Youden, que se calcula a partir de la curva ROC y busca maximizar la suma de sensibilidad y especificidad.
Este método resulta en un umbral que balancea la detección de impagos reales con la minimización de falsos positivos, ajustándose de manera más precisa al objetivo del análisis.

```{r roc}
roc_data_logit <- data.frame(
  Especificidad = roc_logit$specificities,
  Sensibilidad = roc_logit$sensitivities
) %>%
  arrange(Especificidad)

auc_logit <- round(auc(roc_logit), 3)

Curva_ROC_Logit <- ggplot(roc_data_logit, aes(x = Especificidad, y = Sensibilidad)) +
  geom_ribbon(aes(ymin = 0, ymax = Sensibilidad),
              fill = "#d6eaf8", alpha = 0.8) +
  geom_segment(aes(x = 1, y = 0, xend = 0, yend = 1),
               color = "grey60", linetype = "dashed", linewidth = 0.8) +
  geom_line(color = "#1a5276", linewidth = 1.4) +
  geom_text(
    aes(x = 0.3, y = 0.1),
    label = paste("AUC =", auc_logit, "\nUmbral óptimo =", round(umbral, 3)),
    color = "#1a5276",
    fontface = "bold",
    size = 4
  ) +
  scale_x_reverse(
    name = "Especificidad",
    limits = c(1, 0),
    breaks = seq(1, 0, -0.2),
    expand = c(0.02, 0.02)
  ) +
  scale_y_continuous(
    name = "Sensibilidad",
    limits = c(0, 1),
    breaks = seq(0, 1, 0.2),
    expand = c(0.02, 0.02)
  ) +
  labs(
    title = "Curva ROC del Modelo Logit",
    subtitle = "Evaluación del desempeño del modelo de regresión logística en la clasificación de incumplimientos",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)."
  ) +
  tema +  # usa tu tema definido anteriormente
  theme(
    text = element_text(family = "Segoe UI"),
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5, color = "#2c3e50"),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "#34495e", margin = margin(b = 10)),
    plot.caption = element_text(size = 9, color = "#7f8c8d", hjust = 0.5, margin = margin(t = 15)),
    axis.title = element_text(face = "bold", size = 11, color = "#2c3e50"),
    legend.position = "none"
  )

Curva_ROC_Logit

```

El valor óptimo hallado para el umbral fue aproximadamente igual a `r round(umbral, 3)`.
Esta selección garantiza que las predicciones del modelo logístico sean lo más equilibradas posible en términos de identificación de impagos y minimización de errores.

El valor del área bajo la curva (AUC) que obtenemos de la curva ROC para el modelo logístico es de aproximadamente 0.646, lo cual indica que el modelo tiene una capacidad moderada para distinguir entre los préstamos que serán pagados y los que incumplirán.
Un AUC de 0.5 representa un modelo sin capacidad discriminativa (aleatorio), mientras que un AUC de 1 indica discriminación perfecta.
Por tanto, un valor cercano a 0.65 muestra que el modelo tiene un rendimiento mejor que el azar, pero aún bajo para ser concluyente.

La siguiente gráfica muestra la variación de las principales métricas (precisión, sensibilidad, especificidad y exactitud) en función del punto de corte, permitiendo identificar visualmente el umbral óptimo y su impacto sobre el desempeño del clasificador.

```{r bisaje}
performa <- function(cutoff, prob, ref, postarget, negtarget) {
  predict <- factor(ifelse(prob >= cutoff, postarget, negtarget))
  
  if (length(unique(predict)) < 2) return(rep(NA, 4))
  
  conf <- caret::confusionMatrix(predict, ref, positive = postarget)
  
  acc  <- conf$overall["Accuracy"]
  rec  <- conf$byClass["Sensitivity"]
  prec <- conf$byClass["Precision"]
  spec <- conf$byClass["Specificity"]
  
  return(c(recall = rec, accuracy = acc, precision = prec, specificity = spec))
}

co <- seq(0.01, 0.80, length = 100)
result <- t(sapply(co, performa,
                   prob = p_hat,
                   ref = test_logit$estado_pago,
                   postarget = "No_paga",
                   negtarget = "Paga"))

result <- as.data.frame(result)
colnames(result) <- c("Recall", "Accuracy", "Precision", "Specificity")

result <- result %>%
  mutate(Cutoff = co) %>%
  pivot_longer(cols = c(Recall, Accuracy, Precision, Specificity),
               names_to = "Métrica",
               values_to = "Valor")

grafico_umbral_logit <- ggplot(result, aes(x = Cutoff, y = Valor, color = Métrica)) +
  geom_line(linewidth = 1.2, alpha = 0.9) +
  geom_vline(xintercept = umbral, color = "#c0392b", linetype = "dashed", linewidth = 1) +
  annotate(
    "label",
    x = umbral, y = 0.95,
    label = paste0("Umbral óptimo = ", round(umbral, 3)),
    color = "white", fill = "#c0392b", fontface = "bold",
    size = 3.5, label.size = 0.3, label.padding = unit(0.15, "lines")
  ) +
  scale_color_manual(values = c(
    "Recall" = "#f39c12",
    "Accuracy" = "#1a5276",
    "Precision" = "#27ae60",
    "Specificity" = "#8e44ad"
  )) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 0.8, 0.1)) +
  labs(
    title = "Desempeño del Modelo Logit según el Umbral (Cutoff)",
    subtitle = "Comparación de métricas de clasificación al variar el punto de corte",
    x = "Umbral de decisión",
    y = "Valor de la métrica",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)."
  ) +
  tema +  
  theme(
    text = element_text(family = "Segoe UI"),
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5, color = "#2c3e50"),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "#34495e", margin = margin(b = 10)),
    plot.caption = element_text(size = 9, color = "#7f8c8d", hjust = 0.5, margin = margin(t = 15)),
    axis.title = element_text(face = "bold", size = 11, color = "#2c3e50"),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 10, color = "#2c3e50")
  )

grafico_umbral_logit

```

Posteriormente, se obtienen las predicciones para el conjunto de prueba, con las cuales se construye la matriz de confusión que permite evaluar el desempeño del modelo en términos de clasificaciones correctas e incorrectas.
Además, se calculan las métricas clave que describen la eficacia del modelo para detectar tanto los incumplimientos (“No_paga”) como los préstamos pagados (“Paga”).

```{r con_logit}
cm_logit <- confusionMatrix(pred_clase_logit, test_logit$estado_pago, positive = "No_paga")

matriz_conf_logit <- matrix(
  c(cm_logit$table[1], cm_logit$table[2],
    cm_logit$table[3], cm_logit$table[4]),
  nrow = 2, byrow = TRUE,
  dimnames = list(
    "Predicción" = c("Paga", "No_paga"),
    "Referencia" = c("Paga", "No_paga"))
)

matriz_conf_logit %>%
  kbl(
    caption = "Tabla 5. Matriz de Confusión del Modelo Logit (con umbral óptimo)",
    align = c("c", "c", "c"),
    col.names = c("Paga", "No_paga")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  add_header_above(c(" " = 1, "Referencia" = 2),
                   bold = TRUE, background = "#2b6cb0", color = "white") %>%
  footnote(
    general = "La matriz presenta las predicciones frente a los valores reales para la clase positiva 'No_paga'.",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

acc <- round(cm_logit$overall["Accuracy"], 4)
acc_ci <- paste0("(", round(cm_logit$overall[["AccuracyLower"]], 4), ", ",
                 round(cm_logit$overall[["AccuracyUpper"]], 4), ")")

no_info_rate <- round(as.numeric(cm_logit$overall[[3]]), 4)
p_value_acc <- "<2.2e-16"
kappa <- round(cm_logit$overall["Kappa"], 4)
mcnemar <- formatC(as.numeric(cm_logit$overall["McnemarPValue"]), format = "e", digits = 2)

metricas_logit <- data.frame(
  Métrica = c(
    "Accuracy (Exactitud)",
    "95% CI (Intervalo de Confianza)",
    "No Information Rate",
    "P-Value [Acc > NIR]",
    "Kappa",
    "Mcnemar's Test P-Value",
    "Sensitivity",
    "Specificity",
    "Pos Pred Value",
    "Neg Pred Value",
    "Prevalence",
    "Detection Rate",
    "Detection Prevalence",
    "Balanced Accuracy"
  ),
  Valor = c(
    acc,
    acc_ci,
    no_info_rate,
    p_value_acc,
    kappa,
    mcnemar,
    round(cm_logit$byClass["Sensitivity"], 4),
    round(cm_logit$byClass["Specificity"], 4),
    round(cm_logit$byClass["Pos Pred Value"], 4),
    round(cm_logit$byClass["Neg Pred Value"], 4),
    round(cm_logit$byClass["Prevalence"], 4),
    round(cm_logit$byClass["Detection Rate"], 4),
    round(cm_logit$byClass["Detection Prevalence"], 4),
    round(cm_logit$byClass["Balanced Accuracy"], 4)
  ),
  Interpretación = c(
    "Proporción total de clasificaciones correctas realizadas por el modelo Logit.",
    "Margen de incertidumbre del 95% sobre la precisión estimada del modelo.",
    "Exactitud esperada si el modelo predijera siempre la clase mayoritaria.",
    "Evalúa si la exactitud del modelo es significativamente mejor que el azar.",
    "Grado de concordancia entre predicciones y valores reales, ajustado por azar.",
    "Evalúa si existe sesgo en los errores entre clases 'Paga' y 'No_paga'.",
    "Proporción de casos 'No_paga' correctamente identificados (sensibilidad).",
    "Proporción de casos 'Paga' correctamente identificados (especificidad).",
    "Probabilidad de que una predicción 'No_paga' sea correcta (precisión positiva).",
    "Probabilidad de que una predicción 'Paga' sea correcta (precisión negativa).",
    "Frecuencia real de la clase 'No_paga' en los datos de prueba.",
    "Porcentaje de 'No_paga' correctamente detectados entre todos los casos.",
    "Frecuencia con la que el modelo predice 'No_paga' en el total de observaciones.",
    "Promedio entre sensibilidad y especificidad, mide desempeño global balanceado."
  )
)
metricas_logit %>%
  kbl(
    caption = "Tabla 6. Métricas de Evaluación del Modelo Logit (con umbral óptimo)",
    align = c("l", "c", "l"),
    col.names = c("Métrica", "Valor", "Interpretación")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 13,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3.5cm") %>%
  column_spec(2, width = "2.5cm") %>%
  column_spec(3, width = "10cm") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018).",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )
```

Los resultados de la matriz de confusión muestran un desempeño moderado del modelo.
Se observa que el modelo predice correctamente 742 casos de préstamos pagados y 788 casos de incumplimiento, lo cual es positivo.
Sin embargo, también comete errores importantes, clasificando erróneamente 534 préstamos pagados como incumplidos (falsos positivos) y 436 incumplimientos como pagos (falsos negativos).

La exactitud global de 61.2% indica que el modelo acierta en seis de cada diez casos, lo cual mejora respecto a la tasa de información nula (51%) y es estadísticamente significativo (p-valor \< 2.2e-16).
No obstante, el coeficiente Kappa de 0.225 revela que la concordancia entre las predicciones y las observaciones reales solo es moderadamente mejor que el azar.

La sensibilidad del 64.4% muestra que el modelo identifica correctamente cerca de dos tercios de los incumplimientos reales, mientras que la especificidad del 58.2% indica que detecta un poco más de la mitad de los pagos correctamente.
Los valores predictivos también son moderados, con un 59.6% para la clase "No_paga" y un 63.0% para la clase "Paga".

En conjunto, estos indicadores sugieren que aunque el modelo Logit tiene capacidad para identificar el riesgo crediticio mejor que un modelo aleatorio, su desempeño no es óptimo ni robusto para aplicaciones críticas sin ajustes adicionales o modelos complementarios.
Representa un punto de partida aceptable, pero requiere optimizaciones para mejorar la confiabilidad en la detección de incumplimientos y minimizar las falsas alarmas que podrían afectar decisiones financieras.

# Comparación de modelos

Para comparar los modelos KNN y regresión logística utilizados en este análisis, se opta por evaluar el desempeño del modelo KNN implementado con el paquete caret, que facilita la integración de variables categóricas y numéricas, así como la optimización de sus hiperparámetros mediante validación cruzada.

La comparación se basa en métricas clave como la exactitud, sensibilidad, especificidad y el área bajo la curva ROC (AUC), que ya hemos abordado anteriormente.
Estas medidas permiten evaluar cuál modelo clasifica mejor, identifica con mayor precisión los incumplimientos y mantiene un buen equilibrio entre detección y falsos positivos.

A continuación, se presenta una tabla resumen con los valores principales de estas métricas para ambos modelos, que permite una comparación rápida y clara de sus rendimientos y limita el juicio a evidencia cuantitativa.

```{r comparacion}
cm_caret <- confusionMatrix(pred_clase_knn, test$estado_pago, positive = "No_paga")

# --- 2. MATRIZ DE CONFUSIÓN LOGIT ---
cm_logit <- confusionMatrix(pred_clase_logit, test_logit$estado_pago, positive = "No_paga")

# --- 3. TABLA COMPARATIVA ---
comparacion_integral <- data.frame(
  Metrica = c(
    "Accuracy (Exactitud)",
    "Sensitivity (Sensibilidad)",
    "Specificity (Especificidad)",
    "Precision (Valor Predictivo Positivo)",
    "Balanced Accuracy",
    "AUC (Area bajo la curva ROC)",
    "Casos correctamente clasificados - Paga",
    "Casos correctamente clasificados - No_paga"
  ),
  `Modelo KNN` = c(
    round(cm_caret$overall["Accuracy"], 4),
    round(cm_caret$byClass["Sensitivity"], 4),
    round(cm_caret$byClass["Specificity"], 4),
    round(cm_caret$byClass["Pos Pred Value"], 4),
    round(cm_caret$byClass["Balanced Accuracy"], 4),
    round(auc(roc_knn), 4),
    cm_caret$table[1, 1],
    cm_caret$table[2, 2]
  ),
  `Modelo Logit` = c(
    round(cm_logit$overall["Accuracy"], 4),
    round(cm_logit$byClass["Sensitivity"], 4),
    round(cm_logit$byClass["Specificity"], 4),
    round(cm_logit$byClass["Pos Pred Value"], 4),
    round(cm_logit$byClass["Balanced Accuracy"], 4),
    round(auc(roc_logit), 4),
    cm_logit$table[1, 1],
    cm_logit$table[2, 2]
  )
)

comparacion_integral %>%
  kbl(
    caption = "Tabla 7. Comparacion integral del desempeno entre los modelos KNN y Logit",
    align = c("l", "c", "c"),
    col.names = c("Metrica", "KNN", "Logit")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 13,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  row_spec(6, extra_css = "border-bottom: 2px solid #2b6cb0;") %>%
  column_spec(1, bold = TRUE, width = "5cm") %>%
  column_spec(2:3, width = "3cm") %>%
  footnote(
    general = "Elaboracion propia con base en el dataset Lending Club (2007–2018).",
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )

```

La tabla de comparación integral entre KNN (con caret) y regresión logística (Logit) muestra que ambos modelos presentan desempeños relativamente similares en la mayoría de los indicadores, aunque existen diferencias que pueden resultar más relevantes dependiendo del objetivo analítico.

Logit logra una mayor exactitud y mejor especificidad, lo que se traduce en un menor número de falsos positivos al identificar pagos correctamente.
KNN, por su parte, exhibe una sensibilidad ligeramente superior y clasifica más casos de “No_paga” de manera correcta, lo que puede ser valioso cuando la prioridad es identificar el mayor número posible de incumplimientos, aun aceptando un número mayor de falsos positivos.

```{r area}

roc_knn_df <- data.frame(
  FPR = 1 - roc_knn$specificities,
  TPR = roc_knn$sensitivities,
  Modelo = "KNN"
)

roc_logit_df <- data.frame(
  FPR = 1 - roc_logit$specificities,
  TPR = roc_logit$sensitivities,
  Modelo = "Logit"
)

roc_comparada <- rbind(roc_knn_df, roc_logit_df)

auc_knn <- round(auc(roc_knn), 3)
auc_logit <- round(auc(roc_logit), 3)

ggplot(roc_comparada, aes(x = FPR, y = TPR, color = Modelo)) +
  geom_line(linewidth = 1.2) +
  geom_abline(linetype = "dashed", color = "#b0b0b0") +
  annotate("text", x = 0.65, y = 0.15,
           label = paste0("AUC KNN = ", auc_knn),
           color = "#1a5276", fontface = "bold", size = 4.2) +
  annotate("text", x = 0.65, y = 0.07,
           label = paste0("AUC Logit = ", auc_logit),
           color = "#2874a6", fontface = "bold", size = 4.2) +
  scale_color_manual(values = c("KNN" = "#1a5276", "Logit" = "#2874a6")) +
  labs(
    title = "Curvas ROC comparadas entre KNN y Logit",
    subtitle = "Visualización de la capacidad discriminativa de ambos modelos",
    x = "Tasa de falsos positivos (1 - Especificidad)",
    y = "Tasa de verdaderos positivos (Sensibilidad)",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)"
  ) +
  tema +
  theme(legend.position = "bottom", legend.title = element_blank())

```

Sin embargo, la diferencia en el área bajo la curva (AUC) es mínima, denotando que ambos modelos muestran una capacidad similar para distinguir entre pagos e impagos de manera global.

```{r barras}
metricas_comparacion <- data.frame(
  Métrica = rep(c("Accuracy", "Sensibilidad", "Especificidad", "Precisión", "Balanced Accuracy"), each = 2),
  Modelo = rep(c("KNN", "Logit"), times = 5),
  Valor = c(
    cm_caret$overall["Accuracy"],
    cm_logit$overall["Accuracy"],
    cm_caret$byClass["Sensitivity"],
    cm_logit$byClass["Sensitivity"],
    cm_caret$byClass["Specificity"],
    cm_logit$byClass["Specificity"],
    cm_caret$byClass["Pos Pred Value"],
    cm_logit$byClass["Pos Pred Value"],
    cm_caret$byClass["Balanced Accuracy"],
    cm_logit$byClass["Balanced Accuracy"]
  )
)

ggplot(metricas_comparacion, aes(x = Métrica, y = Valor, fill = Modelo)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.6) +
  geom_text(aes(label = round(Valor, 3)), 
            position = position_dodge(0.75), vjust = -0.5, size = 3.5, color = "#323130") +
  scale_fill_manual(values = c("KNN" = "#1a5276", "Logit" = "#2874a6")) +
  labs(
    title = "Comparación de métricas clave entre KNN y Logit",
    subtitle = "Las barras muestran el desempeño relativo de los modelos",
    x = "",
    y = "Valor de la métrica",
    caption = "Fuente: Elaboración propia con base en el dataset Lending Club (2007–2018)"
  ) +
  tema +
  theme(legend.position = "bottom", legend.title = element_blank())
```

Estas métricas reflejan que ninguno de los dos modelos predomina claramente sobre el otro en todos los aspectos; cada uno presenta fortalezas y limitaciones que se deben ponderar según el contexto del problema y la tolerancia al riesgo o error que se adopten en la aplicación real.
Así, la decisión de adoptar, combinar, o mejorar alguno de estos enfoques requerirá una reflexión adicional sobre el objetivo de negocio y las restricciones prácticas del sistema de decisión.

# Conclusiones

El presente estudio tuvo como objetivo desarrollar y comparar modelos de clasificación supervisada para predecir el riesgo de incumplimiento en préstamos personales, empleando datos públicos de Lending Club y contrastando dos aproximaciones metodológicas: K-Vecinos Más Cercanos (KNN) y regresión logística (Logit).
Los hallazgos obtenidos permiten extraer conclusiones tanto sobre el desempeño técnico de los modelos como sobre las implicaciones prácticas para la gestión del riesgo crediticio.

Ambos modelos demostraron una capacidad moderada para discriminar entre préstamos pagados e incumplimientos, con métricas de exactitud cercanas al 60% y valores de AUC alrededor de 0.65.
Estos resultados, si bien superan significativamente el desempeño aleatorio (p \< 0.001), revelan limitaciones importantes en la capacidad predictiva cuando se emplean únicamente variables disponibles ex ante en un contexto de scoring crediticio.
El modelo de regresión logística alcanzó una exactitud del 61.2% y un AUC de 0.646, mostrando ligeras ventajas en términos de especificidad (58.2%) y precisión general.
Su naturaleza paramétrica facilitó la interpretación de los efectos individuales de cada predictor: el ingreso anual y el puntaje FICO mostraron efectos protectores estadísticamente significativos (coeficientes negativos, p \< 0.001), mientras que la relación deuda/ingreso y el monto del préstamo incrementaron el riesgo de incumplimiento de manera sistemática.
La determinación del umbral óptimo mediante el índice de Youden (0.513) permitió balancear sensibilidad (64.4%) y especificidad, optimizando la capacidad discriminativa del modelo dentro de sus límites estructurales.

Por su parte, el modelo KNN implementado con caret evidenció una exactitud del 59.8% y un AUC de 0.645, con una sensibilidad superior (66.2%) que lo hace más efectivo para identificar casos de incumplimiento, aunque a costa de una especificidad menor (53.6%).
La optimización automática mediante validación cruzada identificó k=235 como el valor óptimo, y la incorporación de la variable categórica proposito_agrupado enriqueció la información disponible respecto a implementaciones más básicas del algoritmo.
No obstante, la naturaleza no paramétrica de KNN limita la interpretabilidad de las decisiones, lo que puede representar una desventaja en contextos regulatorios o cuando se requiere justificar explícitamente los criterios de aprobación crediticia.

El análisis descriptivo y los coeficientes estimados en el modelo Logit confirmaron patrones esperados desde la teoría del riesgo crediticio.
El puntaje FICO se consolidó como el predictor más robusto, reflejando su capacidad para sintetizar información histórica sobre comportamiento de pago.
Los ingresos elevados actuaron como factor protector, aunque con efectos moderados, posiblemente debido a la subdeclaración o variabilidad temporal inherente a esta medida.
La relación deuda/ingreso demostró ser un indicador crítico de presión financiera, con efectos positivos significativos sobre la probabilidad de default.

El propósito del préstamo, aunque incluido en ambos modelos, mostró efectos marginalmente significativos o no significativos en varias categorías, sugiriendo que su poder discriminativo es limitado cuando se controla por variables financieras cuantitativas.
Esto indica que las diferencias en el riesgo asociado al destino del crédito pueden estar mediadas principalmente por otras características del solicitante (capacidad de pago, historial) más que por el propósito en sí mismo.

El monto del préstamo presentó un efecto positivo sobre el incumplimiento, coherente con la hipótesis de que obligaciones mayores incrementan la carga mensual y alargan el horizonte de exposición al riesgo, especialmente en ausencia de ajustes proporcionales en las condiciones o capacidad de pago del solicitante.

La construcción de una muestra balanceada mediante undersampling (5,000 casos por clase) permitió entrenar modelos sin sesgos hacia la clase mayoritaria, mejorando la sensibilidad en la detección de incumplimientos.
Esta decisión metodológica fue apropiada para el contexto de evaluación de algoritmos, aunque debe reconocerse que la prevalencia real en la población original (aproximadamente 20% de incumplimientos) implica que las métricas obtenidas podrían variar en aplicaciones operativas donde se preserve el desbalance natural.

El uso de validación cruzada estratificada y la búsqueda sistemática de hiperparámetros en KNN garantizaron robustez en la selección de modelos, minimizando el riesgo de sobreajuste.
La estandarización de variables numéricas y el tratamiento adecuado de valores extremos mediante filtros justificados contribuyeron a la calidad de los datos empleados en el modelado.

La fijación de semillas aleatorias (set.seed(28)) en todas las operaciones estocásticas aseguró reproducibilidad, un requisito esencial para la validación científica y la replicabilidad de los resultados.

**¿Logró el estudio responder al objetivo de investigación?**

Los modelos desarrollados demostraron capacidad para identificar patrones de riesgo y clasificar solicitantes con un desempeño parcialmente superior al azar, cumpliendo así con el propósito de comparar dos aproximaciones metodológicas (paramétrica vs. no paramétrica) y evaluar su aplicabilidad en scoring crediticio.
Sin embargo, los niveles de exactitud y AUC obtenidos (cercanos al 60% y 0.65 respectivamente) son insuficientes para sostener un sistema de decisión crediticia operativo sin complementos adicionales.

En términos técnicos, el estudio evidenció que las variables financieras tradicionales (ingreso, DTI, FICO, monto) contienen señal predictiva real, pero esta señal es limitada.
La brecha entre el desempeño observado y el desempeño óptimo sugiere que existen factores de riesgo no capturados por las variables disponibles, tales como: características cualitativas del empleo, estabilidad laboral, estructura del hogar, historial de pagos no financieros, comportamiento transaccional, o incluso variables macroeconómicas y temporales que podrían modular el riesgo de incumplimiento.

Desde una perspectiva práctica, ninguno de los dos modelos alcanzó niveles de sensibilidad y especificidad suficientes para ser implementados como herramienta única de decisión crediticia.
La tasa de falsos negativos (préstamos clasificados como pagados que terminan en incumplimiento) osciló entre 36% y 44%, lo que implicaría aceptar solicitantes de alto riesgo con consecuencias financieras adversas.
Simultáneamente, las tasas de falsos positivos (préstamos clasificados como incumplimientos que en realidad se pagarían) oscilaron entre 42% y 46%, lo que limitaría el acceso al crédito de solicitantes viables y reduciría la rentabilidad de la cartera.

-   

Con base en los hallazgos, se proponen varias estrategias para mejorar la práctica crediticia.
La incorporación de variables adicionales, como antigüedad laboral, tipo de contrato o comportamiento transaccional, puede enriquecer la base de datos y potenciar la capacidad predictiva.
Además, la adopción de modelos ensemble, que combinan múltiples algoritmos para captar relaciones complejas, representa una prometedora vía para superar las limitaciones de modelos individuales.

La segmentación de cartera permite adaptar modelos específicos a grupos homogéneos, optimizando la precisión según características particulares.
Es recomendable también implementar ajustes dinámicos en los umbrales de decisión para adaptarse al apetito de riesgo y condiciones del mercado.
En la práctica, un sistema híbrido que integre modelos estadísticos y reglas de negocio, junto con monitoreo continuo y recalibración, garantizará mayor robustez y adaptabilidad frente a cambios.

No obstante, es importante reconocer las limitaciones del análisis realizado.
El uso de undersampling y la exclusión de valores extremos pueden sesgar las métricas obtenidas, y la base pública carece de información detallada que está disponible en entornos reales de crédito.
Tampoco se controlaron efectos temporales ni se aplicó validación cruzada extensa, lo que limita la generalización de los resultados.

Finalmente, el estudio confirma la viabilidad del aprendizaje supervisado para la clasificación de riesgo crediticio, pero evidencia que los modelos Logit y KNN por sí solos en estas condiciones podrian no ser suficientes para aplicaciones operativas directas.
Cada enfoque tiene fortalezas y debilidades complementarias, y la mejora continua mediante inclusive más variables, técnicas avanzadas y controles éticos es clave para su aplicación práctica.

# Bibliografia

-   Paredes, D. (2024). Aprendizaje supervisado. <https://bookdown.org/dparedesi/data-science-con-r/aprendizaje-supervisado.html>\
-   Ariza-Garzón, M. J., Sanz-Guerrero, M., Javier, A. G., & Club, L. (2024). Lending Club loan dataset for granting models. Zenodo. <https://doi.org/10.5281/zenodo.11295916>
-   James, G., Witten, D., Hastie, T. & Tibshirani, R. (2021). An Introduction to Statistical Learning with Applications in R (2nd ed.). Springer.\
-   Aguirre, J., et al. (2024). Modelo de regresión lineal para el análisis del ingreso de los hogares en la región Pacífica (ECV 2024). Publicado en RPubs: <https://rpubs.com/joanaguirre04/1353677>
