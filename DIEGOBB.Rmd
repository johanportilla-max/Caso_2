```{r sep, echo = FALSE, warning = FALSE, message = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(tidyr)
library(readr)
library(tidyverse)
library(class)
library(caret)
library(pROC)
library(ggthemes)
library(lubridate)
library(kableExtra)
library(knitr)
library(ggcorrplot)
library(scales)
library(gridExtra)
library(grid)
library(ggplotify)
library(broom)
library(DT)
library(dplyr)
library(scales)
```

```{r tema2, echo = FALSE, warning = FALSE, message = FALSE}
tema <- theme_minimal() +
  theme(
    text = element_text(family = "Segoe UI", color = "#2d3748"),
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, color = "#323130"),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "#605e5c", margin = margin(b = 15)),
    plot.caption = element_text(size = 10, color = "#605e5c", hjust = 0),
    panel.grid.major = element_line(color = "#f3f2f1"),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    axis.title = element_text(face = "bold", color = "#323130"),
    axis.text = element_text(color = "#605e5c"),
    legend.position = "none"
  )
```

## Preparación y limpieza de datos

```{r carga_datos, echo = FALSE, warning = FALSE, message = FALSE}

lending_raw <- read_csv("LC_loans_granting_model_dataset.csv", guess_max = 20000)

lending_base <- lending_raw %>%
  select(revenue, dti_n, loan_amnt, fico_n, Default, purpose, issue_d) %>%
  rename(
    ingreso = revenue,
    relacion_deuda_ingreso = dti_n,
    monto_prestamo = loan_amnt,
    puntaje_fico = fico_n,
    estado_pago = Default,
    proposito = purpose
  ) %>%
  mutate(
    fecha_emision = parse_date_time(issue_d, orders = "b-Y", locale = "en_US"),
    Año = year(fecha_emision),
    proposito = as.factor(proposito),
    proposito_agrupado = fct_collapse(
      proposito,
      Consolidacion = c("debt_consolidation", "credit_card"),
      Casa_Vehiculo = c("home_improvement", "major_purchase", "car", "house"),
      Negocio_Estudio = c("small_business", "educational")
    ),
    proposito_agrupado = fct_other(
      proposito_agrupado,
      keep = c("Consolidacion", "Casa_Vehiculo", "Negocio_Estudio"),
      other_level = "Otros"
    ),
    estado_pago = fct_recode(as.factor(estado_pago), "Paga" = "0", "No_paga" = "1")
  ) %>%
  select(-proposito)

set.seed(0408)

paga <- lending_base %>% filter(estado_pago == "Paga") %>% sample_n(5000)
nopaga <- lending_base %>% filter(estado_pago == "No_paga") %>% sample_n(5000)
lending_base <- lending_base %>%
  filter(ingreso <= 250000, relacion_deuda_ingreso <= 50) %>%
  drop_na()


Base_datos= bind_rows(paga, nopaga)



```



# Análisis descriptivo


```{r resumen_general, echo = FALSE, warning = FALSE, message = FALSE}
resumen_general <- Base_datos %>%
  select(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico) %>%
  summarise_all(list(
    n = ~sum(!is.na(.)),
    media = ~mean(., na.rm = TRUE),
    mediana = ~median(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE),
    minimo = ~min(., na.rm = TRUE),
    maximo = ~max(., na.rm = TRUE)
  )) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("variable", ".value"),
    names_pattern = "^(.*)_(n|media|mediana|sd|minimo|maximo)$"
  )
```

## Estadísticas descriptivas de las variables principales

```{r tabla_resumen }

tabla_resumen = resumen_general %>%
  select(-n) %>%  
  kable(
    format = "html",
    col.names = c("Variable", "Media", "Mediana", "Desv. Estándar", "Mínimo", "Máximo"),
    align = c('l', 'r', 'r', 'r', 'r', 'r'),
    caption = "Tabla 1: Estadísticas Descriptivas de las Variables Principales del Dataset de Préstamos"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2, width = "2cm") %>%
  column_spec(3, width = "2cm") %>%
  column_spec(4, width = "2.5cm") %>%
  column_spec(5, width = "2cm") %>%
  column_spec(6, width = "2cm") %>%
  footnote(
    general = fuente_texto,
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )
tabla_resumen
```




## Distribución de frecuencias por estado de pago

```{r tabla_frecuencias}
tabla_estado <- as.data.frame(table(lending_base$estado_pago))
colnames(tabla_estado) <- c("estado_pago", "n")
tabla_estado$porcentaje <- round(prop.table(tabla_estado$n) * 100, 2)
tabla_estado %>%
  kbl(
    caption = "Tabla 2: Distribución de Frecuencias por Estado de Pago",
    align = c("l", "r", "r"),
    col.names = c("Estado Pago", "Frecuencia", "Porcentaje (%)")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "3cm") %>%
  column_spec(2:3, width = "2.5cm") %>%
  footnote(
    general = fuente_texto,
    general_title = "Nota:",
    footnote_as_chunk = TRUE
  )
```


# Distribución individual de variables numéricas

## Histograma del ingreso

```{r p1}
library(plotly)
p1 <- ggplot(Base_datos, aes(x = ingreso)) +
  geom_histogram(binwidth = 5000, fill = "#2b6cb0", color = "white", alpha = 0.8) +
  geom_vline(xintercept = median(lending_base$ingreso), color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = dollar_format(prefix = "$", big.mark = ",")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    title = "Histograma del Ingreso (Mediana en Rojo)",
    x = "Ingreso",
    y = "Frecuencia",
    caption = fuente_texto
  ) +
  tema
p1

```



## Distribución de la relación deuda/ingreso

```{r pdti}
p_dti <- ggplot(Base_datos, aes(x = relacion_deuda_ingreso)) +
  geom_density(fill = "#2a9d8f", color = "#1b4d47", alpha = 0.4, size = 1.1) +
  geom_vline(xintercept = median(lending_base$relacion_deuda_ingreso), color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = percent_format(scale = 1)) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    title = "Distribución de la Relación Deuda/Ingreso (Mediana en Rojo)",
    x = "Relación deuda/ingreso (%)",
    y = "Densidad",
    caption = fuente_texto
  ) +
  tema
p_dti


```



## Distribución del puntaje FICO

```{r fico}
p_fico <- ggplot(Base_datos, aes(x = puntaje_fico)) +
  geom_density(bw = 15, fill = "#52b788", color = "#1b4332", alpha = 0.8, size = 1.1) +
  geom_vline(xintercept = median(lending_base$puntaje_fico), color = "#e63946", linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = seq(600, 850, 25), limits = c(600, 850)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), labels = comma_format()) +
  labs(
    title = "Distribución del Puntaje FICO (Mediana en Rojo)",
    x = "Puntaje FICO",
    y = "Densidad",
    caption = fuente_texto
  ) +
  tema +
  theme(
    plot.title = element_text(face = "bold", size = 14, color = "#1b4332"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank()
  )
p_fico
```



## Distribución del monto del préstamo

```{r p_monto}
p_monto_hist <- ggplot(Base_datos, aes(x = monto_prestamo)) +
  geom_histogram(binwidth = 1000, fill = "#2a9d8f", color = "white", alpha = 0.9) +
  geom_vline(xintercept = median(lending_base$monto_prestamo), color = "red", linetype = "dashed", size = 0.9) +
  scale_x_continuous(labels = dollar_format(prefix = "$", big.mark = ",")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    title = "Distribución del Monto del Préstamo (Mediana en Rojo)",
    x = "Monto del préstamo (USD)",
    y = "Frecuencia",
    caption = fuente_texto
  ) +
  tema
p_monto_hist

```


# Variable por estado de pago

## Puntaje FICO por estado de pago

```{r ficopagaono}
p_fico_box <- ggplot(Base_datos, aes(x = estado_pago, y = puntaje_fico, fill = estado_pago)) +
  geom_boxplot() +
  labs(
    title = "Puntaje FICO por Estado de Pago",
    x = "Estado de pago",
    y = "Puntaje FICO",
    caption = fuente_texto
  ) +
  tema
print(p_fico_box)


```


## ingreso por estado de pago

```{r ingresopaga on o paga}

p_box_ingreso <- ggplot(Base_datos, aes(x = estado_pago, y = ingreso, fill = estado_pago)) +
  geom_boxplot(alpha = 0.7, outlier.color = "gray40", outlier.alpha = 0.4) +
  scale_fill_manual(values = c("Paga" = "#1b9e77", "No_paga" = "#d95f02")) +
  scale_y_continuous(labels = dollar_format(prefix = "$", big.mark = ",")) +
  labs(
    title = "Ingreso por Estado de Pago",
    x = "Estado de pago",
    y = "Ingreso (USD)",
    caption = fuente_texto
  ) +
  tema
p_box_ingreso
```


## Comparación de variables numéricas según estado de pago

```{r todasvariable}

p_comparativo <- Base_datos %>%
  pivot_longer(cols = c(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico),
               names_to = "variable", values_to = "valor") %>%
  ggplot(aes(x = estado_pago, y = valor, fill = estado_pago)) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.3) +
  facet_wrap(~ variable, scales = "free", ncol = 2) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("Paga" = "#1b9e77", "No_paga" = "#d95f02")) +
  labs(
    title = "Comparación de Variables Numéricas por Estado de Pago",
    x = "Estado de pago",
    y = "Valor",
    caption = fuente_texto
  ) +
  tema
print(p_comparativo)
```


# Relaciónes

## Relación entre puntaje FICO y relación deuda/ingreso

```{r fico_dti_simplificado}
set.seed(123)
sample_plot <- Base_datos %>% sample_n(8000)
ggplot(sample_plot, aes(x = puntaje_fico, y = relacion_deuda_ingreso)) +
  geom_smooth(method = "loess", se = TRUE, color = "#1b4332", fill = "#95d5b2", linewidth = 1.2, alpha = 0.3) +
  scale_y_continuous(labels = percent_format(scale = 1)) +
  scale_x_continuous(breaks = seq(600, 850, 25)) +
  labs(
    title = "Relación entre Puntaje FICO y Relación Deuda/Ingreso",
    x = "Puntaje FICO",
    y = "Relación deuda/ingreso (%)",
    caption = paste0(fuente_texto, " (Muestra aleatoria de 8,000 obs.)")
  ) +
  tema +
  theme(legend.position = "none", panel.grid.minor = element_blank())
sample_plot
```



## Relación entre ingreso y monto del préstamo

```{r montovsingresos}
corr_val <- cor(Base_datos$ingreso, Base_datos$monto_prestamo, use = "complete.obs")
p_monto <- ggplot(Base_datos, aes(x = ingreso, y = monto_prestamo)) +
  geom_point(aes(color = estado_pago), alpha = 0.35, size = 1.4) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs"), color = "#264653", fill = "#a8dadc", size = 1, se = TRUE) +
  scale_x_continuous(labels = dollar_format(prefix = "$", big.mark = ","), expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(labels = dollar_format(prefix = "$", big.mark = ","), expand = expansion(mult = c(0.02, 0.02))) +
  scale_color_manual(values = c("Paga" = "#2a9d8f", "No_paga" = "#e76f51"), name = "Estado de pago") +
  labs(
    title = "Relación entre Ingreso del Solicitante y Monto del Préstamo",
    x = "Ingreso del solicitante (USD)",
    y = "Monto del préstamo (USD)",
    caption = fuente_texto
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", color = "#1d3557"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),
    plot.margin = margin(10, 15, 10, 15)
  )
p_monto
```



## Relación entre puntaje FICO y relación deuda/ingreso

```{r ficovsdti}

set.seed(123)
sample_plot <- Base_datos %>% sample_n(10000)
ggplot(sample_plot, aes(x = puntaje_fico, y = relacion_deuda_ingreso)) +
  geom_point(alpha = 0.05, size = 0.6, color = "#6baed6") +
  geom_smooth(method = "loess", se = TRUE, color = "black", size = 1) +
  scale_y_continuous(labels = percent_format(scale = 1)) +
  labs(
    title = "Relación entre Puntaje FICO y Relación Deuda/Ingreso",
    x = "Puntaje FICO",
    y = "Relación deuda/ingreso (%)",
    caption = paste0(fuente_texto, " (Muestra aleatoria de 10,000 obs.)")
  ) +
  tema
print(p_fico_dti_smooth)

```


# Tasas

## Tasa de default por decil de ingreso

```{r decil}
lending_tasa <- Base_datos %>%
  mutate(decil_ingreso = ntile(ingreso, 10)) %>%
  group_by(decil_ingreso) %>%
  summarise(
    tasa_default = mean(estado_pago == "No_paga"),
    ingreso_prom = mean(ingreso),
    .groups = "drop"
  )

ggplot(Base_datos, aes(x = reorder(factor(decil_ingreso), ingreso_prom), y = tasa_default, group = 1)) +
  geom_line(color = "#2b6cb0", size = 1.2) +
  geom_point(size = 3, color = "#2b6cb0", fill = "white", shape = 21) +
  geom_text(aes(label = percent(tasa_default, accuracy = 0.1)), vjust = -0.8, size = 3.2) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_discrete(labels = paste0("D", 1:10)) +
  labs(
    title = "Tasa de Default (No Paga) por Decil de Ingreso",
    x = "Decil de ingreso",
    y = "Tasa de default (No_paga)",
    caption = fuente_texto
  ) +
  tema +
  theme(legend.position = "none")
print(p_tasa)
```


## Tasa de Default e Indicadores por Propósito del Préstamo

```{r tasadeafuprposiotltingreso}

tasa_por_proposito <- Base_datos %>%
  group_by(proposito_agrupado) %>%
  summarise(
    tasa_no_paga = mean(estado_pago == "No_paga"),
    ingreso_mediano = median(ingreso),
    fico_mediano = median(puntaje_fico),
    .groups = "drop"
  ) %>%
  mutate(
    tasa_no_paga = round(tasa_no_paga, 3),
    ingreso_mediano = round(ingreso_mediano, 1),
    fico_mediano = round(fico_mediano, 1)
  )

tasa_por_proposito %>%
  kbl(
    caption = "Tabla 3: Tasa de Default e Indicadores por Propósito del Préstamo",
    align = c("l", "r", "r", "r"),
    col.names = c("Propósito", "Tasa No Paga", "Ingreso Mediano", "FICO Mediano")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 14,
    position = "center"
  ) %>%
  row_spec(0, background = "#2b6cb0", color = "white", bold = TRUE) %>%
  footnote(general = fuente_texto, general_title = "Nota:", footnote_as_chunk = TRUE)
```


# Propósito

## Distribución del puntaje FICO por propósito y estado de pago

```{r fico proposito}

p_fico_proposito <- ggplot(lending_base, aes(x = puntaje_fico, fill = estado_pago)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ proposito_agrupado, ncol = 2) +
  scale_fill_manual(values = c("Paga" = "#4daf4a", "No_paga" = "#e41a1c")) +
  labs(
    title = "Distribución del Puntaje FICO por Propósito y Estado de Pago",
    x = "Puntaje FICO",
    y = "Densidad",
    caption = fuente_texto
  ) +
  tema +
  theme(legend.position = "bottom")
print(p_fico_proposito)
```

# Correlacion

## Matriz de correlaciones entre variables numéricas

```{r correlacion}
library(plotly)
numeric_vars <- Base_datos %>% select(ingreso, relacion_deuda_ingreso, monto_prestamo, puntaje_fico)
cor_mat <- cor(numeric_vars, use = "complete.obs")

ggcorrplot(
  cor_mat,
  lab = TRUE,
  lab_size = 4,
  colors = c("#de425b", "white", "#2ca25f"),
  title = "Matriz de correlaciones entre variables numéricas",
  outline.col = "white"
) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.caption = element_text(size = 10, color = "#605e5c", hjust = 0)
  ) +
  labs(caption = fuente_texto)
p_cor_interactivo
```